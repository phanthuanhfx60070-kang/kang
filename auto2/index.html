<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>哨兵量化 - V42 实盘盈亏精准核算版</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        async function bootstrap() {
            let config = null;
            try {
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    config = JSON.parse(__firebase_config);
                }
            } catch (e) {}

            if (config && config.apiKey) {
                const app = initializeApp(config);
                window.auth = getAuth(app);
                window.db = getFirestore(app);
                window.appId = typeof __app_id !== 'undefined' ? __app_id : 'sentinel-v41';

                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(window.auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(window.auth);
                    }
                } catch (e) {}
            }
        }
        bootstrap();
    </script>

    <style>
        body { background-color: #0b0e11; color: #eaecef; font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: contain; }
        .app-card { background: linear-gradient(145deg, #1e2329, #161a1e); border-radius: 24px; border: 1px solid #2b3139; position: relative; overflow: hidden; transition: all 0.3s; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .input-dark { background-color: #0b0e11; border: 1px solid #2b3139; border-radius: 12px; padding: 12px; color: white; font-size: 14px; width: 100%; outline: none; }
        .input-dark:focus { border-color: #f0b90b; }
        .profit { color: #0ecb81; }
        .loss { color: #f6465d; }
        .nav-item.active { color: #f0b90b; }
        #customModal { display: none; position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); align-items: center; justify-content: center; padding: 20px; }
        ::-webkit-scrollbar { display: none; }
        .rsi-high { color: #f6465d; text-shadow: 0 0 10px rgba(246, 70, 93, 0.5); }
        .waiting-glow { animation: pulse-yellow 2s infinite; }
        .live-glow { border-color: #f6465d !important; box-shadow: 0 0 15px rgba(246, 70, 93, 0.1); }
        .shield-active { background: rgba(14, 203, 129, 0.1); border: 1px solid #0ecb81; color: #0ecb81; font-weight: 900; padding: 2px 6px; border-radius: 6px; font-size: 8px; text-transform: uppercase; }
        .sub-tab-btn.active { background: #f0b90b; color: #0b0e11; font-weight: 900; }
        
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #2b3139; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #f6465d; }
        input:checked + .slider:before { transform: translateX(14px); }
    </style>
</head>
<body>

    <!-- 顶部状态栏 -->
    <div id="topHeader" class="sticky top-0 z-50 bg-[#0b0e11]/95 backdrop-blur-md border-b border-[#2b3139] px-4 py-3 flex justify-between items-center text-white text-left">
        <div class="flex-shrink min-w-0 pr-2">
            <h1 class="text-lg font-black text-[#f0b90b] italic tracking-tighter uppercase truncate">Sentinel Pro</h1>
            <div class="flex items-center gap-1">
                <span id="apiStatusDot" class="w-1.5 h-1.5 rounded-full bg-slate-600"></span>
                <p id="globalStatus" class="text-[7px] font-bold text-slate-500 uppercase tracking-widest truncate">Live Portfolio Active</p>
            </div>
        </div>
        <div class="flex gap-2 flex-shrink-0">
            <button onclick="confirmAction('ALL_TP')" class="bg-[#0ecb81] text-white px-3 py-1.5 rounded-full font-black text-[9px] shadow-lg active:scale-95 whitespace-nowrap">一键全平</button>
            <button onclick="openAddModal()" class="bg-[#f0b90b] text-[#0b0e11] px-3 py-1.5 rounded-full font-black text-[9px] shadow-lg active:scale-95 whitespace-nowrap">+ 部署</button>
        </div>
    </div>

    <main class="px-4 py-6 pb-32 max-w-4xl mx-auto">
        <!-- 终端看板 -->
        <section id="tab-lab" class="tab-content active space-y-6 text-left">
            <div class="grid grid-cols-2 gap-4">
                <div class="app-card p-5 text-center border-t-2 border-[#f0b90b]">
                    <p class="text-[10px] text-slate-500 font-black uppercase mb-1">累计摸顶净利润</p>
                    <p id="totalSimPnl" class="text-xl font-black profit">0.00 U</p>
                </div>
                <div id="liveBalanceCard" class="app-card p-5 text-center border-t-2 border-slate-500">
                    <p class="text-[10px] text-slate-500 font-black uppercase mb-1">可用钱包余额</p>
                    <p id="liveBalance" class="text-xl font-black text-slate-200">--</p>
                </div>
            </div>
            <div id="strategyGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </section>

        <!-- 实盘持仓 (修复盈利显示逻辑) -->
        <section id="tab-portfolio" class="tab-content space-y-4 text-left">
            <div class="app-card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-black text-[#f0b90b] italic uppercase text-sm">币安合约真实持仓</h3>
                    <button onclick="renderPortfolio()" class="text-[9px] text-slate-500 underline uppercase">同步账户</button>
                </div>
                <div id="portfolioList" class="divide-y divide-white/5 space-y-1">
                    <p class="py-10 text-center opacity-30 text-[10px] uppercase font-black text-white">正在载入数据...</p>
                </div>
            </div>
        </section>

        <!-- 行情榜 -->
        <section id="tab-market" class="tab-content space-y-4">
            <div class="app-card p-6">
                <div class="flex justify-between items-center mb-6 text-left">
                    <h3 class="text-lg font-black text-[#f0b90b] italic uppercase text-sm">24H 实时行情</h3>
                    <div class="flex gap-2">
                        <button id="btn-spot" onclick="switchMarketType('spot')" class="sub-tab-btn active px-3 py-1.5 rounded-lg text-[10px] bg-slate-800 text-white font-black">现货</button>
                        <button id="btn-futures" onclick="switchMarketType('futures')" class="sub-tab-btn px-3 py-1.5 rounded-lg text-[10px] bg-slate-800 text-slate-500 font-black">合约</button>
                    </div>
                </div>
                <div class="relative mb-4 text-left">
                    <input type="text" id="marketSearch" oninput="filterMarketList()" class="input-dark pl-10 text-xs py-3" placeholder="搜索币种 (如: SOL, BTC, PEPE)...">
                    <svg class="w-4 h-4 text-slate-500 absolute left-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <div id="gainersList" class="divide-y divide-white/5 max-h-[55vh] overflow-y-auto pr-1 text-white"></div>
            </div>
        </section>

        <!-- 执行流水 -->
        <section id="tab-alerts" class="tab-content text-left">
            <div class="app-card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-black text-[#f0b90b] italic uppercase text-sm">系统执行流水</h3>
                    <button onclick="clearAlertHistory()" class="text-[9px] text-slate-500 underline uppercase">清空</button>
                </div>
                <div id="alertLogList" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2"></div>
            </div>
        </section>

        <!-- 设置 -->
        <section id="tab-account" class="tab-content text-left">
            <div class="app-card p-8 text-white">
                <h3 class="text-center font-black text-[#f0b90b] mb-8 tracking-widest uppercase text-sm italic text-center">账户设置</h3>
                <div class="space-y-4">
                    <input type="password" id="apiKey" class="input-dark" placeholder="Binance API Key">
                    <input type="password" id="apiSecret" class="input-dark" placeholder="Binance Secret Key">
                    <button onclick="saveKeys()" class="w-full py-4 bg-[#f0b90b] text-[#0b0e11] font-black rounded-2xl uppercase text-xs shadow-lg active:scale-95">保存密钥</button>
                </div>
            </div>
        </section>
    </main>

    <!-- 底部导航 -->
    <nav class="fixed bottom-0 left-0 right-0 bg-[#1e2329]/95 backdrop-blur-lg border-t border-white/5 px-2 pt-3 pb-[calc(env(safe-area-inset-bottom)+12px)] flex justify-around items-center z-50 text-center">
        <button onclick="showTab('lab')" id="nav-lab" class="nav-item active flex flex-col items-center gap-1 flex-1 min-w-0">
            <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
            <span class="text-[8px] sm:text-[9px] font-black uppercase truncate">终端</span>
        </button>
        <button onclick="showTab('portfolio')" id="nav-portfolio" class="nav-item flex flex-col items-center gap-1 flex-1 min-w-0 text-slate-500">
            <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <span class="text-[8px] sm:text-[9px] font-black uppercase truncate">实盘持仓</span>
        </button>
        <button onclick="showTab('market')" id="nav-market" class="nav-item flex flex-col items-center gap-1 flex-1 min-w-0 text-slate-500">
            <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
            <span class="text-[8px] sm:text-[9px] font-black uppercase truncate">行情</span>
        </button>
        <button onclick="showTab('alerts')" id="nav-alerts" class="nav-item flex flex-col items-center gap-1 flex-1 min-w-0 text-slate-500">
            <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            <span class="text-[8px] sm:text-[9px] font-black uppercase truncate">流水</span>
        </button>
        <button onclick="showTab('account')" id="nav-account" class="nav-item flex flex-col items-center gap-1 flex-1 min-w-0 text-slate-500">
            <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
            <span class="text-[8px] sm:text-[9px] font-black uppercase truncate">配置</span>
        </button>
    </nav>

    <!-- 配置弹窗 -->
    <div id="modal" class="fixed inset-0 bg-black/95 backdrop-blur-2xl hidden flex items-center justify-center z-[100] p-6 overflow-y-auto text-white text-left">
        <div class="bg-[#1e2329] w-full max-w-lg p-8 my-10 rounded-[2.5rem] border border-[#2b3139] shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black text-[#f0b90b] italic uppercase">方案部署</h2>
                <button onclick="closeModal()" class="text-slate-500 text-3xl">&times;</button>
            </div>
            <div class="space-y-5 text-left">
                <div class="grid grid-cols-2 gap-4 text-left">
                    <div>
                        <label class="text-[10px] text-slate-500 font-black ml-1 uppercase">交易对</label>
                        <input type="text" id="botSymbol" class="input-dark mt-1 uppercase font-bold text-white text-left" value="SOLUSDT">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 font-black ml-1 uppercase">杠杆倍数</label>
                        <input type="number" id="botLev" class="input-dark mt-1 text-left" value="20">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 text-left">
                    <div>
                        <label class="text-[10px] text-red-500 font-black ml-1 uppercase italic">手动开仓价</label>
                        <input type="number" id="botManualPrice" class="input-dark mt-1 font-mono text-[#f0b90b] text-left" placeholder="留空则自动偏移">
                    </div>
                    <div>
                        <label class="text-[10px] text-blue-400 font-black ml-1 uppercase italic text-left">单笔金额 (U)</label>
                        <input type="number" id="botAddVal" class="input-dark mt-1 font-bold text-white text-left" value="5.5">
                    </div>
                </div>

                <div class="p-4 bg-red-500/5 rounded-2xl border border-red-500/10 text-xs text-left">
                    <p class="text-red-500 font-bold mb-2 uppercase tracking-widest text-left">自动判定参数</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span>RSI (15m) ></span>
                            <input type="number" id="botRsiLimit" class="bg-transparent border-b border-red-900 w-full text-white py-1 outline-none text-left" value="97">
                        </div>
                        <div>
                            <span>针尖偏移 %</span>
                            <input type="number" id="botOffset" class="bg-transparent border-b border-red-900 w-full text-white py-1 outline-none text-left" value="1.13">
                        </div>
                    </div>
                </div>

                <div class="p-4 bg-blue-500/5 rounded-2xl border border-blue-500/10 text-[10px] text-slate-400 space-y-1 text-left">
                    <p>● 盈利达 <span class="text-white">40%</span> 开启 <span class="text-emerald-500 font-bold">均价保本盾</span></p>
                    <p>● 盈利达 <span class="text-white">50%</span> 自动减仓一半 | 1小时未达标全平</p>
                    <p>● <span class="text-white font-bold">6小时强制结清</span></p>
                    <p>● <span class="text-red-400 font-bold">3次补仓完再亏50%强制结清</span></p>
                    <p class="pt-2 text-blue-400 font-bold text-left">● 亏损达 50% 自动加仓一次 (最多3次)</p>
                </div>
                <button onclick="saveBot()" class="w-full py-4 bg-[#0ecb81] text-[#0b0e11] rounded-2xl font-black uppercase text-sm shadow-xl active:scale-95 transition-transform text-center">确认部署方案</button>
            </div>
        </div>
    </div>

    <!-- 确认模态 -->
    <div id="customModal">
        <div class="bg-[#1e2329] p-8 rounded-[2rem] w-full max-w-xs text-center border border-white/5 text-white">
            <h3 id="cmTitle" class="text-lg font-black text-[#f0b90b] mb-2 uppercase italic text-center">系统确认</h3>
            <p id="cmText" class="text-xs text-slate-400 mb-8 px-4 text-center">是否执行此项实盘指令？</p>
            <div class="flex gap-4 text-left">
                <button onclick="closeCM()" class="flex-1 py-3 text-slate-500 font-black text-[10px] uppercase text-center">取消</button>
                <button id="cmConfirmBtn" class="flex-1 py-3 bg-[#f6465d] text-white rounded-xl font-black text-[10px] uppercase text-center text-center text-center">执行</button>
            </div>
        </div>
    </div>

    <script>
        let strategies = [];
        let alertHistory = [];
        let marketFeed = {};
        let rawMarketData = [];
        let exchangeInfoMap = {};
        const FAPI_BASE = "https://fapi.binance.com";
        const SPOT_BASE = "https://api.binance.com";

        window.onload = async () => {
            await fetchExchangeInfo();
            try {
                const saved = localStorage.getItem('sentinel_v28_strategies');
                const logs = localStorage.getItem('sentinel_v28_alerts');
                if(saved) strategies = JSON.parse(saved);
                if(logs) alertHistory = JSON.parse(logs);
            } catch(e) {}
            ['apiKey', 'apiSecret'].forEach(k => {
                const v = localStorage.getItem('s_' + k);
                if(v) document.getElementById(k).value = v;
            });
            renderStrategies();
            renderAlerts();
            startMainLoop();
        };

        async function fetchExchangeInfo() {
            try {
                const resp = await fetch(`${FAPI_BASE}/fapi/v1/exchangeInfo`).then(r => r.json());
                if (resp && resp.symbols) {
                    resp.symbols.forEach(s => {
                        exchangeInfoMap[s.symbol] = {
                            pricePrecision: s.pricePrecision,
                            quantityPrecision: s.quantityPrecision,
                            stepSize: s.filters.find(f => f.filterType === 'LOT_SIZE').stepSize,
                            tickSize: s.filters.find(f => f.filterType === 'PRICE_FILTER').tickSize
                        };
                    });
                }
            } catch (e) {}
        }

        function formatQuantity(symbol, qty, isOpening = false) {
            const info = exchangeInfoMap[symbol];
            if (!info) return qty.toFixed(3);
            const p = info.quantityPrecision;
            const factor = Math.pow(10, p);
            if (isOpening) return (Math.ceil(qty * factor) / factor).toFixed(p);
            else return (Math.floor(qty * factor) / factor).toFixed(p);
        }

        async function signedRequest(method, endpoint, params = {}) {
            const key = localStorage.getItem('s_apiKey');
            const secret = localStorage.getItem('s_apiSecret');
            if (!key || !secret) return { error: "密钥缺失" };
            const timestamp = Date.now();
            let query = Object.keys(params).map(k => `${k}=${params[k]}`).join('&');
            query += (query ? '&' : '') + `timestamp=${timestamp}&recvWindow=10000`;
            const signature = CryptoJS.HmacSHA256(query, secret).toString(CryptoJS.enc.Hex);
            try {
                const url = `${FAPI_BASE}${endpoint}?${query}&signature=${signature}`;
                return await fetch(url, { method: method, headers: { 'X-MBX-APIKEY': key } }).then(r => r.json());
            } catch (e) { return { error: "网络异常" }; }
        }

        async function executeLiveTrade(bot, side, qty, reason, isClosing = false) {
            const key = localStorage.getItem('s_apiKey');
            if (!key) return;
            const safeQty = !isClosing ? (qty * 1.02) : qty; 
            const formattedQty = formatQuantity(bot.symbol, safeQty, !isClosing);
            const params = { symbol: bot.symbol, side: side, type: 'MARKET', quantity: formattedQty };
            if (isClosing) params.reduceOnly = "true";
            const result = await signedRequest('POST', '/fapi/v1/order', params);
            if (result.orderId) {
                triggerReminder(`[实盘成功] ${bot.symbol} ${reason}, 数量:${formattedQty}`, 'system');
            } else {
                triggerReminder(`[实盘失败] ${bot.symbol} ${result.msg || "接口异常"}`, 'loss');
            }
        }

        async function startMainLoop() {
            setInterval(async () => {
                refreshBalance();
                const uniqueSymbols = [...new Set(strategies.map(s => s.symbol))];
                for(const sym of uniqueSymbols) {
                    try {
                        const [resp15, resp1] = await Promise.all([
                            fetch(`${FAPI_BASE}/fapi/v1/klines?symbol=${sym}&interval=15m&limit=100`).then(r => r.json()),
                            fetch(`${FAPI_BASE}/fapi/v1/klines?symbol=${sym}&interval=1m&limit=5`).then(r => r.json())
                        ]);
                        marketFeed[sym] = { 
                            price: parseFloat(resp1[resp1.length-1][4]), 
                            open1m: parseFloat(resp1[resp1.length-1][1]), 
                            rsi15: calculateRSI(resp15.map(d => parseFloat(d[4])), 14) 
                        };
                    } catch(e) {}
                }
                processAdvancedLogic();
                if(document.getElementById('tab-portfolio').classList.contains('active')) renderPortfolio();
            }, 3000); 
        }

        function calculateRSI(closes, period = 14) {
            if (closes.length < period + 1) return 50;
            let gains = []; let losses = [];
            for (let i = 1; i < closes.length; i++) {
                let diff = closes[i] - closes[i - 1];
                gains.push(diff >= 0 ? diff : 0);
                losses.push(diff < 0 ? Math.abs(diff) : 0);
            }
            let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
            let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;
            for (let i = period; i < gains.length; i++) {
                avgGain = (avgGain * (period - 1) + gains[i]) / period;
                avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
            }
            if (avgLoss === 0) return 100;
            return 100 - (100 / (1 + (avgGain / avgLoss)));
        }

        function processAdvancedLogic() {
            const now = Date.now();
            strategies.forEach(bot => {
                const feed = marketFeed[bot.symbol];
                if(!feed) return;
                bot.entryTarget = bot.manualPrice > 0 ? bot.manualPrice : feed.open1m * (1 + bot.offset / 100);

                if(bot.state === 'IDLE') {
                    const rsiOk = feed.rsi15 >= bot.rsiLimit;
                    const priceOk = feed.price >= bot.entryTarget;
                    if(rsiOk && priceOk) {
                        const openQty = bot.addVal / feed.price;
                        bot.state = 'HOLDING'; bot.entryPrice = feed.price; bot.lastEntryPrice = feed.price; 
                        bot.currentAmtU = bot.addVal; bot.entryTime = now; bot.maxPnlEver = 0;
                        bot.halfExited = false; bot.entryCount = 1; bot.shieldActive = false; bot.pnl = 0;
                        bot.executedQty = openQty;
                        triggerReminder(`[成交] ${bot.symbol} 入场位:${bot.entryPrice.toFixed(4)}`, 'entry');
                        executeLiveTrade(bot, 'SELL', openQty, '开空入场', false);
                    } else { bot.isRsiReady = rsiOk; }
                } else if(bot.state === 'HOLDING') {
                    const durationMs = now - bot.entryTime;
                    const hoursElapsed = durationMs / (1000 * 60 * 60);
                    bot.pnl = (bot.entryPrice - feed.price) / bot.entryPrice * bot.lev * 100;
                    if(bot.pnl > bot.maxPnlEver) bot.maxPnlEver = bot.pnl;

                    if(!bot.shieldActive && bot.pnl >= 40) {
                        bot.shieldActive = true;
                        triggerReminder(`[盾] ${bot.symbol} 40%锁保本激活`, 'system');
                    }
                    if(bot.shieldActive && feed.price > bot.entryPrice) {
                        closePosition(bot, `保本止损`, 'loss'); return;
                    }
                    if(bot.pnl <= -50) {
                        if (bot.entryCount <= 3) {
                            const addQty = bot.addVal / feed.price;
                            const oldVal = bot.currentAmtU; const newVal = bot.addVal;
                            bot.entryPrice = ((bot.entryPrice * oldVal) + (feed.price * newVal)) / (oldVal + newVal);
                            bot.currentAmtU += newVal; bot.lastEntryPrice = feed.price; bot.entryCount += 1;
                            bot.executedQty += addQty; bot.shieldActive = false;
                            triggerReminder(`[加仓] ${bot.symbol} 第${bot.entryCount}层完成`, 'add');
                            executeLiveTrade(bot, 'SELL', addQty, '补仓', false);
                        } else {
                            closePosition(bot, `3补完亏50%强平`, 'loss'); return;
                        }
                    }
                    if(bot.pnl >= 50 && !bot.halfExited) {
                        const exitQty = bot.executedQty / 2;
                        bot.totalProfit += (bot.currentAmtU / 2) * (bot.pnl / 100);
                        bot.currentAmtU /= 2; bot.executedQty -= exitQty; bot.halfExited = true;
                        triggerReminder(`[半平] ${bot.symbol} 50%锁利`, 'profit');
                        executeLiveTrade(bot, 'BUY', exitQty, '减仓', true);
                    }
                    if(hoursElapsed >= 1 && bot.maxPnlEver < 50) { closePosition(bot, "1h未达标", 'profit'); return; }
                    if(hoursElapsed >= 6) { closePosition(bot, "6h强制结清", 'profit'); return; }
                }
            });
            renderStrategies(); saveData();
        }

        function closePosition(bot, reason, type) {
            executeLiveTrade(bot, 'BUY', bot.executedQty, reason, true);
            const finalProfit = (bot.currentAmtU * (bot.pnl / 100));
            bot.totalProfit += finalProfit; bot.state = 'IDLE'; bot.isRsiReady = false; bot.shieldActive = false;
            bot.executedQty = 0;
            triggerReminder(`[离场] ${bot.symbol} ${reason}: ${finalProfit.toFixed(2)}U`, type);
        }

        // --- 核心修复：持仓页精准盈亏核算逻辑 ---
        async function renderPortfolio() {
            const container = document.getElementById('portfolioList');
            const result = await signedRequest('GET', '/fapi/v2/positionRisk');
            
            if (result.error) {
                container.innerHTML = `<p class="py-10 text-center text-red-500 text-xs font-bold">${result.error}</p>`;
                return;
            }

            const activePositions = result.filter(pos => parseFloat(pos.positionAmt) !== 0);

            if (!activePositions.length) {
                container.innerHTML = '<p class="py-20 text-center opacity-30 text-[10px] font-black uppercase tracking-widest text-white text-left">实盘账户暂无活跃持仓</p>';
                return;
            }

            container.innerHTML = activePositions.map(pos => {
                const amt = parseFloat(pos.positionAmt) || 0;
                const entryPrice = parseFloat(pos.entryPrice) || 0;
                const markPrice = parseFloat(pos.markPrice) || 0;
                const leverage = parseFloat(pos.leverage) || 1;
                const side = amt > 0 ? 'LONG' : 'SHORT';
                
                // 1. 优先获取 API 提供的盈亏，若为 0 则通过价格公式手动纠偏
                let upnl = parseFloat(pos.unrealizedProfit) || 0;
                if (upnl === 0 && entryPrice > 0 && markPrice > 0) {
                    if (side === 'LONG') {
                        upnl = (markPrice - entryPrice) * amt;
                    } else {
                        upnl = (entryPrice - markPrice) * Math.abs(amt);
                    }
                }
                
                // 2. 计算价值与ROE% (ROE = PnL / (Size * EntryPrice / Leverage))
                const notional = Math.abs(amt * markPrice);
                let pnlPct = 0;
                const marginUsed = (Math.abs(amt) * entryPrice) / leverage;
                if (marginUsed > 0) {
                    pnlPct = (upnl / marginUsed) * 100;
                }

                return `
                <div class="py-4 border-b border-white/5 last:border-0 text-left">
                    <div class="flex justify-between items-start mb-3 text-left">
                        <div class="text-left">
                            <p class="font-black text-sm text-white uppercase truncate">${pos.symbol}</p>
                            <p class="text-[9px] font-bold ${side === 'LONG' ? 'profit' : 'loss'} uppercase">${side} ${leverage}X</p>
                        </div>
                        <div class="text-right text-left">
                            <span class="block text-[8px] text-slate-500 uppercase font-black">实时盈亏</span>
                            <span class="text-sm font-mono font-black ${upnl >= 0 ? 'profit' : 'loss'}">
                                ${upnl >= 0 ? '+' : ''}${upnl.toFixed(2)} U
                            </span>
                            <span class="block text-[10px] font-bold ${upnl >= 0 ? 'profit' : 'loss'}">${pnlPct.toFixed(2)}%</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mb-3 text-left">
                        <div class="bg-white/5 rounded-lg p-2 text-left">
                            <span class="block text-[7px] text-slate-500 uppercase">入场均价</span>
                            <span class="text-[10px] font-mono text-slate-300">${entryPrice.toFixed(4)}</span>
                        </div>
                        <div class="bg-white/5 rounded-lg p-2 text-left">
                            <span class="block text-[7px] text-slate-500 uppercase">标记价格</span>
                            <span class="text-[10px] font-mono text-[#f0b90b] font-bold">${markPrice.toFixed(4)}</span>
                        </div>
                    </div>

                    <div class="flex justify-between items-center text-left">
                        <div class="text-left">
                             <span class="block text-[8px] text-slate-500 uppercase">数量 / 名义价值</span>
                             <span class="text-[10px] font-mono text-white font-bold">${Math.abs(amt)} / ${notional.toFixed(2)} U</span>
                        </div>
                        <button onclick="closeRealPosition('${pos.symbol}', ${Math.abs(amt)}, '${side}')" class="bg-red-500/20 hover:bg-red-500 border border-red-500/50 text-red-500 hover:text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-all active:scale-90 text-left">平仓</button>
                    </div>
                </div>`;
            }).join('');
        }

        async function closeRealPosition(symbol, qty, side) {
            const closeSide = side === 'LONG' ? 'SELL' : 'BUY';
            const formattedQty = formatQuantity(symbol, qty, false);
            const params = { symbol: symbol, side: closeSide, type: 'MARKET', quantity: formattedQty, reduceOnly: "true" };
            const result = await signedRequest('POST', '/fapi/v1/order', params);
            if (result.orderId) {
                triggerReminder(`[手动平仓] ${symbol} 指令已发送`, 'system');
                setTimeout(renderPortfolio, 1000);
            } else {
                triggerReminder(`[平仓失败] ${symbol}: ${result.msg}`, 'loss');
            }
        }

        function renderStrategies() {
            const grid = document.getElementById('strategyGrid');
            if(!grid) return;
            if(strategies.length === 0) { grid.innerHTML = '<p class="col-span-full py-20 text-center opacity-30 text-[10px] font-black uppercase text-white tracking-widest text-center text-left">等待部署...</p>'; return; }
            grid.innerHTML = strategies.map(bot => {
                const feed = marketFeed[bot.symbol] || { price: 0, rsi15: 0 };
                const isReady = bot.state === 'IDLE' && bot.isRsiReady;
                const h = bot.state === 'HOLDING' ? ((Date.now() - bot.entryTime) / (1000 * 60 * 60)).toFixed(2) : 0;
                return `
                <div class="app-card p-6 ${isReady ? 'waiting-glow' : ''} ${bot.isLive ? 'live-glow' : ''} text-left">
                    <div class="flex justify-between items-start mb-4 text-left">
                        <div class="min-w-0 text-left">
                            <h4 class="font-black text-white italic uppercase text-sm truncate">${bot.symbol}</h4>
                            <p class="text-[9px] text-slate-500 uppercase tracking-tighter text-left">${bot.isLive ? '实盘' : '模拟'} · ${bot.state==='HOLDING'?h+'h':'待机'}</p>
                        </div>
                        <div class="flex items-center gap-3 text-left">
                            <label class="switch"><input type="checkbox" ${bot.isLive ? 'checked' : ''} onchange="toggleLiveMode(${bot.id})"><span class="slider"></span></label>
                            <button onclick="deleteBot(${bot.id})" class="text-slate-700 hover:text-red-500 pb-1"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293-4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/></svg></button>
                        </div>
                    </div>
                    <div class="text-center mb-6 border-b border-white/5 pb-4">
                        <p class="text-3xl font-mono font-black text-white tracking-tighter">${feed.price ? feed.price.toFixed(feed.price < 1 ? 5 : 4) : '---'}</p>
                        <p class="text-[8px] text-slate-500 uppercase font-black tracking-widest mt-1 italic text-center text-left">Market Price</p>
                    </div>
                    <div class="flex justify-between items-center mb-6 text-center text-left">
                        <div class="flex-1 text-left text-center">
                            <p class="text-[8px] text-slate-600 font-black uppercase mb-1">RSI (15m)</p>
                            <p class="text-xl font-black ${feed.rsi15 >= bot.rsiLimit ? 'rsi-high' : 'text-white'}">${feed.rsi15.toFixed(2)}</p>
                        </div>
                        <div class="w-px h-8 bg-white/5 mx-2"></div>
                        <div class="flex-1 text-left text-center">
                            <p class="text-[8px] text-slate-600 font-black uppercase mb-1">PnL %</p>
                            <p class="text-xl font-mono font-black ${bot.pnl >= 0 ? 'profit' : 'loss'}">${(bot.pnl || 0).toFixed(2)}%</p>
                        </div>
                    </div>
                    <div class="bg-black/40 rounded-xl p-3 border border-white/5 flex justify-between items-center text-[10px] mb-2 text-left">
                        <span class="text-slate-600 font-bold uppercase truncate pr-2">均价/目标位</span>
                        <p class="font-mono font-bold text-[#f0b90b] whitespace-nowrap text-right text-left">${bot.state === 'HOLDING' ? bot.entryPrice.toFixed(4) : (bot.entryTarget ? bot.entryTarget.toFixed(4) : '---')}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-3 text-center text-left">
                         <div class="bg-white/5 rounded-lg py-1.5 text-left"><span class="block text-[7px] text-slate-500 uppercase">补仓</span><span class="text-xs font-bold text-blue-400">${bot.state==='HOLDING'?(bot.entryCount-1)+'/3':'READY'}</span></div>
                         <div class="bg-white/5 rounded-lg py-1.5 text-left"><span class="block text-[7px] text-slate-500 uppercase">模拟获利</span><span class="text-xs font-bold text-white">${bot.totalProfit.toFixed(2)}U</span></div>
                    </div>
                </div>`;
            }).join('');
            let t = 0; strategies.forEach(s => t += s.totalProfit);
            if(document.getElementById('totalSimPnl')) document.getElementById('totalSimPnl').innerText = t.toFixed(2) + " U";
        }

        async function fetchMarketData(type = 'spot') {
            const list = document.getElementById('gainersList'); if(!list) return;
            list.innerHTML = '<p class="py-10 text-center text-[10px] opacity-30 font-black italic text-white text-left">同步中...</p>';
            const endpoint = type === 'spot' ? `${SPOT_BASE}/api/v3/ticker/24hr` : `${FAPI_BASE}/fapi/v1/ticker/24hr`;
            try {
                const r = await fetch(endpoint).then(res => res.json());
                rawMarketData = r.filter(i => i.symbol.endsWith('USDT') && parseFloat(i.lastPrice) > 0).sort((a, b) => parseFloat(b.priceChangePercent) - parseFloat(a.priceChangePercent));
                displayMarketList(rawMarketData.slice(0, 50)); 
            } catch (e) { list.innerHTML = '<p class="py-10 text-center text-red-500 text-xs text-left">接口异常</p>'; }
        }

        function displayMarketList(data) {
            const list = document.getElementById('gainersList');
            if(!data.length) { list.innerHTML = '<p class="py-10 text-center text-xs opacity-30 text-white text-left text-center">无匹配</p>'; return; }
            list.innerHTML = data.map(c => {
                const isUp = parseFloat(c.priceChangePercent) >= 0;
                return `<div class="flex justify-between items-center py-4 px-2 hover:bg-white/5 transition-colors text-white text-left"><div class="w-1/3 text-left"><p class="font-black text-sm text-white uppercase tracking-tight">${c.symbol.replace('USDT', '')}</p><p class="text-[8px] text-slate-500 font-bold uppercase tracking-tighter italic">USDT PERP</p></div><div class="w-1/3 text-center text-xs font-mono font-bold text-slate-200">${parseFloat(c.lastPrice).toFixed(parseFloat(c.lastPrice) < 1 ? 5 : 3)}</div><div class="w-1/3 text-right flex items-center justify-end gap-3 text-left text-left text-left"><span class="text-xs font-black ${isUp ? 'profit' : 'loss'}">${isUp ? '+' : ''}${parseFloat(c.priceChangePercent).toFixed(2)}%</span><button onclick="prefillAndOpen('${c.symbol}')" class="bg-[#f0b90b] text-[#0b0e11] px-3 py-1 rounded text-[9px] font-black uppercase shadow-lg active:scale-95 text-left text-center text-center">部署</button></div></div>`;
            }).join('');
        }

        function filterMarketList() {
            const query = document.getElementById('marketSearch').value.toUpperCase();
            displayMarketList(rawMarketData.filter(item => item.symbol.includes(query)).slice(0, 50));
        }

        function switchMarketType(t) {
            document.querySelectorAll('.sub-tab-btn').forEach(btn => { btn.classList.remove('active', 'bg-[#f0b90b]', 'text-[#0b0e11]'); btn.classList.add('bg-slate-800', 'text-slate-500'); });
            const activeBtn = document.getElementById(`btn-${t}`); if(activeBtn) { activeBtn.classList.add('active', 'bg-[#f0b90b]', 'text-[#0b0e11]'); activeBtn.classList.remove('bg-slate-800', 'text-slate-500'); }
            fetchMarketData(t);
        }

        function prefillAndOpen(symbol) { document.getElementById('botSymbol').value = symbol; openAddModal(); }
        async function refreshBalance() {
            const k = localStorage.getItem('s_apiKey'), s = localStorage.getItem('s_apiSecret'); if(!k || !s) return;
            try {
                const ts = Date.now(); const query = `timestamp=${ts}&recvWindow=10000`; const sig = CryptoJS.HmacSHA256(query, s).toString(CryptoJS.enc.Hex);
                const data = await fetch(`${FAPI_BASE}/fapi/v2/balance?${query}&signature=${sig}`, { headers:{'X-MBX-APIKEY':k}}).then(r=>r.json());
                const usdt = data.find(b => b.asset === 'USDT'); if(usdt) { document.getElementById('liveBalance').innerText = parseFloat(usdt.balance).toFixed(2) + " U"; document.getElementById('apiStatusDot').className = "w-2 h-2 rounded-full bg-emerald-500 animate-pulse"; }
            } catch(e) {}
        }
        function saveBot() {
            const bot = { id: Date.now(), symbol: document.getElementById('botSymbol').value.toUpperCase().trim(), manualPrice: parseFloat(document.getElementById('botManualPrice').value) || 0, rsiLimit: parseFloat(document.getElementById('botRsiLimit').value), offset: parseFloat(document.getElementById('botOffset').value), lev: parseFloat(document.getElementById('botLev').value), addVal: parseFloat(document.getElementById('botAddVal').value) || 5.5, state: 'IDLE', isLive: false, isRsiReady: false, shieldActive: false, pnl: 0, totalProfit: 0, currentAmtU: 0, entryTarget: 0, entryTime: null, halfExited: false, maxPnlEver: 0, entryCount: 0, lastEntryPrice: 0, executedQty: 0 };
            strategies.push(bot); saveData(); renderStrategies(); closeModal(); showTab('lab');
        }
        function toggleLiveMode(id) { const bot = strategies.find(s => s.id === id); if (bot) { bot.isLive = !bot.isLive; saveData(); renderStrategies(); } }
        function saveData() { localStorage.setItem('sentinel_v28_strategies', JSON.stringify(strategies)); }
        function deleteBot(id) { strategies = strategies.filter(s=>s.id!==id); saveData(); renderStrategies(); }
        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active','text-[#f0b90b]'));
            document.getElementById(`tab-${id}`).classList.add('active');
            document.getElementById(`nav-${id}`).classList.add('active','text-[#f0b90b]');
            if(id === 'market') fetchMarketData('futures');
            if(id === 'portfolio') renderPortfolio();
        }
        function openAddModal() { document.getElementById('modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        function saveKeys() { ['apiKey','apiSecret'].forEach(k => localStorage.setItem('s_'+k, document.getElementById(k).value.trim())); alert("密钥保存成功"); refreshBalance(); }
        function triggerReminder(msg, type) { try { document.getElementById('alertAudio').play().catch(()=>{}); } catch(e){} alertHistory.unshift({ msg, type, time: new Date().toLocaleTimeString() }); if(alertHistory.length > 50) alertHistory.pop(); localStorage.setItem('sentinel_v28_alerts', JSON.stringify(alertHistory)); renderAlerts(); }
        function renderAlerts() { const c = document.getElementById('alertLogList'); if(!c) return; c.innerHTML = alertHistory.map(a => `<div class="bg-black/40 p-4 rounded-xl border border-white/5 text-[11px] text-white text-left text-left"><span class="opacity-30 mr-2 font-mono">${a.time}</span> ${a.msg}</div>`).join(''); }
        function clearAlertHistory() { alertHistory = []; renderAlerts(); }
        function confirmAction(type) { document.getElementById('cmConfirmBtn').onclick = () => { if(type==='ALL_TP') strategies.filter(s=>s.state==='HOLDING').forEach(b=>closePosition(b, "手动清平", 'profit')); closeCM(); }; document.getElementById('customModal').style.display='flex'; }
        function closeCM() { document.getElementById('customModal').style.display='none'; }
    </script>
</body>
</html>
