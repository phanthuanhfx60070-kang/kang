<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GZ1Z2EZWZD"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-GZ1Z2EZWZD');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KANG Mining (Auto)</title>
    <link rel="icon" href="https://raw.githubusercontent.com/phanthuanhfx60070-kang/kang/refs/heads/main/klogo.png" type="image/x-icon">
    <script src="https://cdn.staticfile.org/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                              radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                              radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            background-size: cover;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            width: 100%; max-width: 400px; border-radius: 24px; padding: 2rem;
            position: relative; z-index: 10;
        }
        
        .btn-gold {
            background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%);
            color: #3e2723; transition: all 0.3s ease; font-weight: 800; border: none;
            cursor: pointer; pointer-events: auto; opacity: 1 !important;
        }
        .btn-gold:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(253, 185, 49, 0.3); }
        
        .btn-green {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: #064e3b; transition: all 0.3s ease; font-weight: 800; border: none;
            cursor: pointer; pointer-events: auto; opacity: 1 !important;
        }
        .btn-green:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(74, 222, 128, 0.4); }

        .pot-glow { text-shadow: 0 0 25px rgba(255, 215, 0, 0.4); }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); }
        .mini-btn {
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: #94a3b8;
            padding: 10px; border-radius: 12px; font-size: 0.75rem; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
        }
        .mini-btn:hover { background: rgba(255,255,255,0.1); color: #FFD700; border-color: #FFD700; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="absolute top-8 w-full text-center z-0">
        <h1 class="text-3xl font-extrabold tracking-tight text-white/90">KANG <span class="text-yellow-500">PROTOCOL</span></h1>
        <p class="text-[10px] text-gray-400 mt-1 tracking-[0.2em] uppercase">Auto Connect ‚Ä¢ Wallet Mode</p>
    </div>

    <div class="glass-card fade-in">
        
        <div class="text-center mb-8">
            <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Current Reward Pot</div>
            <div class="relative">
                <div id="potValue" class="text-5xl font-black text-white pot-glow font-mono">...</div>
                <div class="text-xs font-bold text-yellow-500 mt-2">PENDING KANG TOKENS</div>
            </div>
        </div>

        <div id="connectView" class="text-center hidden">
            <button onclick="connectWallet()" class="btn-gold w-full py-4 rounded-xl text-lg shadow-lg flex items-center justify-center gap-2">
                <i class="fas fa-wallet"></i> ÊâãÂä®ËøûÊé• (Connect)
            </button>
            <p class="text-xs text-gray-500 mt-4">Auto-connect failed, please click manually</p>
        </div>

        <div id="miningView" class="hidden space-y-4">
            <div class="flex justify-between items-center bg-black/20 px-4 py-2 rounded-lg border border-white/5">
                <span class="text-xs text-gray-400">My Balance:</span>
                <span id="myBalance" class="text-sm font-bold text-white font-mono">---</span>
            </div>

            <div id="statusLog" class="bg-gray-800/50 rounded-lg p-3 text-xs text-center text-gray-300 font-mono border border-gray-700/50">
                Ê≠£Âú®ÂêåÊ≠•Êï∞ÊçÆ Syncing...
            </div>

            <div class="grid gap-3">
                <button id="submitBtn" onclick="submitClaim()" class="btn-gold w-full py-4 rounded-xl text-lg shadow-lg relative overflow-hidden">
                    <div class="relative z-10 flex items-center justify-center gap-2">
                        <i class="fas fa-hammer"></i> Á´ãÂç≥Êä¢Â§∫ (Submit)
                    </div>
                </button>

                <div class="text-center py-1">
                    <span id="timerText" class="text-xs text-gray-500 font-mono">--- IDLE ---</span>
                </div>

                <button id="finalizeBtn" onclick="finalizePayout()" class="btn-green w-full py-4 rounded-xl font-bold text-lg shadow-lg">
                    <div class="flex items-center justify-center gap-2">
                        <i class="fas fa-download"></i> ÁªìÁÆóÈ¢ÜÂ∏Å (Finalize)
                    </div>
                </button>
            </div>

            <div class="text-center pt-2">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-black/20 text-[10px] text-gray-400 font-mono">
                    <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                    <span id="userDisplay">0x00...0000</span>
                </div>
            </div>
        </div>

        <div class="action-grid">
            <div class="mini-btn" onclick="copyTokenAddress()">
                <i class="fas fa-copy"></i>
                <span>Â§çÂà∂‰ª£Â∏ÅÂú∞ÂùÄ</span>
            </div>
            <div class="mini-btn" onclick="addTokenToWallet()">
                <i class="fas fa-plus-circle"></i>
                <span>ÂØºÂÖ•Èí±ÂåÖ</span>
            </div>
        </div>

    </div>

    <script>
        // --- 1. ÈÖçÁΩÆÂú∞ÂùÄ ---
        const TOKEN_CA = "0x313F64B887138Db63EE8EdC5d356D40c7EDCe446";
        const GAME_CA = "0xD647f5baEa30c7b038251959671DBFe68672bd30";

        const GAME_ABI = [
            "function submitClaim() public",
            "function finalizePayout() public",
            "function checkCurrentPot() public view returns (uint256)"
        ];

        const TOKEN_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function symbol() view returns (string)"
        ];

        let provider, signer, gameContract, tokenContract;
        let userAddress;
        
        const el = {
            pot: document.getElementById('potValue'),
            connectView: document.getElementById('connectView'),
            miningView: document.getElementById('miningView'),
            status: document.getElementById('statusLog'),
            timer: document.getElementById('timerText'),
            submit: document.getElementById('submitBtn'),
            finalize: document.getElementById('finalizeBtn'),
            user: document.getElementById('userDisplay'),
            balance: document.getElementById('myBalance')
        };

        // --- Ê†∏ÂøÉÔºöÈ°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÔºåÁ´ãÂàªÂ∞ùËØïËøûÊé• ---
        window.onload = async () => {
            // Âª∂Ëøü 500ms Á°Æ‰øùÈí±ÂåÖÊ≥®ÂÖ•ÂÆåÊàê
            setTimeout(autoConnect, 500);
        };

        async function autoConnect() {
            if(!window.ethereum) {
                // Ê≤°Ê£ÄÊµãÂà∞Èí±ÂåÖÔºåÊòæÁ§∫ÊâãÂä®ËøûÊé•ÊåâÈíÆÔºàÊàñËÄÖÊä•ÈîôÊèêÁ§∫Ôºâ
                el.connectView.classList.remove('hidden');
                el.pot.innerText = "No Wallet";
                return;
            }

            try {
                // 1. Â∞ùËØïÈùôÈªòËé∑ÂèñË¥¶Êà∑ (Â¶ÇÊûúÁî®Êà∑‰ª•ÂâçËøûËøáÔºåËøôÊ≠•‰∏çÈúÄË¶ÅÂºπÁ™ó)
                let accounts = await window.ethereum.request({ method: 'eth_accounts' });
                
                if (accounts.length === 0) {
                    // 2. Â¶ÇÊûúÊ≤°ËøûËøáÔºåÂº∫Âà∂ÂºπÂá∫ËØ∑Ê±ÇÁ™óÂè£ (ËøôÂ∞±ÊòØ‰Ω†Ë¶ÅÁöÑÊïàÊûú)
                    // Ê≥®ÊÑèÔºöÂú®Êüê‰∫õÁîµËÑëÊµèËßàÂô®‰∏äËøôÂèØËÉΩ‰ºöË¢´Êã¶Êà™Ôºå‰ΩÜÂú® TP/OKX ÊâãÊú∫Èí±ÂåÖÈáåÈÄöÂ∏∏ÊòØÂÖÅËÆ∏ÁöÑ
                    accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                }

                // 3. ÂºÄÂßãËøûÊé•ÊµÅÁ®ã
                await initGame(accounts[0]);

            } catch (e) {
                console.error("Ëá™Âä®ËøûÊé•Ë¢´ÊãíÁªùÊàñÂ§±Ë¥•", e);
                // Â§±Ë¥•‰∫ÜÔºàÊØîÂ¶ÇÁî®Êà∑ÁÇπ‰∫ÜÂèñÊ∂àÔºâÔºåÈÇ£Â∞±ÊääÊâãÂä®ÊåâÈíÆÊòæÁ§∫Âá∫Êù•ÔºåËÆ©Áî®Êà∑ÊúâÊú∫‰ºöÂÜçÁÇπ
                el.connectView.classList.remove('hidden');
                el.pot.innerText = "Connect Failed";
            }
        }

        // ÊâãÂä®ÁÇπÂáªËøûÊé•ÔºàÂ§áÁî®ÊñπÊ°àÔºâ
        async function connectWallet() {
             try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                await initGame(accounts[0]);
             } catch(e) { alert(e.message); }
        }

        async function initGame(account) {
            try {
                await switchToBSC();

                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = account;

                gameContract = new ethers.Contract(GAME_CA, GAME_ABI, signer);
                tokenContract = new ethers.Contract(TOKEN_CA, TOKEN_ABI, signer);

                // ÈöêËóèËøûÊé•ÊåâÈíÆÔºåÊòæÁ§∫Ê∏∏ÊàèÁïåÈù¢
                el.connectView.classList.add('hidden');
                el.miningView.classList.remove('hidden');
                
                el.user.innerText = userAddress.slice(0,6) + "..." + userAddress.slice(-4);
                el.status.innerText = "Â∑≤ËøûÊé• Connected";
                
                refreshBalance();
                loopPot();

            } catch(e) { console.error(e); }
        }

        async function loopPot() {
            if(gameContract) {
                try {
                    const v = await gameContract.checkCurrentPot();
                    el.pot.innerText = parseFloat(ethers.utils.formatUnits(v, 18)).toFixed(4);
                } catch(e) {}
            }
            setTimeout(loopPot, 3000);
        }

        async function refreshBalance() {
            if(tokenContract && userAddress) {
                try {
                    const rawBal = await tokenContract.balanceOf(userAddress);
                    const bal = parseFloat(ethers.utils.formatUnits(rawBal, 18)).toFixed(2);
                    el.balance.innerText = bal + " KANG";
                } catch(e) {}
            }
        }

        async function submitClaim() {
            try {
                setStatus("Ê≠£Âú®ËØ∑Ê±ÇÈí±ÂåÖÁ≠æÂêç...", "loading");
                const tx = await gameContract.submitClaim();
                setStatus("‰∫§Êòì‰∏äÈìæ‰∏≠...ËØ∑Á®çÂÄô", "loading");
                await tx.wait();
                
                setStatus("ÈîÅÂÆöÊàêÂäüÔºÅÁ≠âÂæÖ 4 ÁßíÂÆâÂÖ®Êúü...", "success");
                let t = 4;
                const iv = setInterval(() => {
                    t--;
                    if(t <= 0) {
                        clearInterval(iv);
                        setStatus("ËØ∑ÁÇπÂáª‰∏ãÊñπÁªøËâ≤ÊåâÈíÆÁªìÁÆóÔºÅ", "warn");
                    } else {
                        el.timer.innerText = `Á≠âÂæÖÂå∫ÂùóÁ°ÆËÆ§... ${t}s`;
                    }
                }, 1000);
            } catch(e) { handleErr(e); }
        }

        async function finalizePayout() {
            try {
                setStatus("Ê≠£Âú®ÂèëËµ∑ÁªìÁÆó...ËØ∑Âú®Èí±ÂåÖÁ°ÆËÆ§", "loading");
                const tx = await gameContract.finalizePayout();
                setStatus("Á≠âÂæÖÂå∫ÂùóÁ°ÆËÆ§...", "loading");
                await tx.wait();
                setStatus("üéâ ÊàêÂäüÔºÅÊî∂ÁõäÂ∑≤Âà∞Ë¥¶", "success");
                refreshBalance();
                setTimeout(() => { location.reload(); }, 2500);
            } catch(e) { handleErr(e); }
        }

        async function switchToBSC() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x38' }],
                });
            } catch (err) {
                if (err.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0x38',
                            chainName: 'Binance Smart Chain',
                            nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
                            rpcUrls: ['https://bsc-dataseed.binance.org/'],
                            blockExplorerUrls: ['https://bscscan.com/'],
                        }],
                    });
                }
            }
        }

        function setStatus(msg, type) {
            el.status.innerText = msg;
            el.status.className = "rounded-lg p-3 text-xs text-center font-mono border transition-all ";
            if(type === 'loading') el.status.className += "bg-blue-900/30 text-blue-300 border-blue-800 animate-pulse";
            else if(type === 'success') el.status.className += "bg-green-900/30 text-green-300 border-green-800";
            else if(type === 'warn') el.status.className += "bg-yellow-900/30 text-yellow-300 border-yellow-800";
            else el.status.className += "bg-gray-800/50 text-gray-300 border-gray-700/50";
        }

        function handleErr(e) {
            let m = "‰∫§ÊòìÂ§±Ë¥•";
            if(e.reason) m = e.reason;
            if(e.message && e.message.includes("user rejected")) m = "Áî®Êà∑ÂèñÊ∂à";
            setStatus("‚ùå " + m, "error");
        }

        function copyTokenAddress() {
            navigator.clipboard.writeText(TOKEN_CA);
            setStatus("‚úÖ ‰ª£Â∏ÅÂú∞ÂùÄÂ∑≤Â§çÂà∂", "success");
            setTimeout(() => setStatus("Â∑≤ËøûÊé• Connected", "normal"), 3000);
        }

        async function addTokenToWallet() {
            if(!window.ethereum) return;
            try {
                await window.ethereum.request({
                    method: 'wallet_watchAsset',
                    params: {
                        type: 'ERC20',
                        options: {
                            address: TOKEN_CA,
                            symbol: 'KANG',
                            decimals: 18,
                        },
                    },
                });
            } catch (error) { console.error(error); }
        }
    </script>
</body>
</html>
