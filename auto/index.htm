<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>量化参数压力测试实验室 - 多指标增强版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { background-color: #0b0e11; color: #eaecef; font-family: -apple-system, system-ui, sans-serif; }
        .glass { background: rgba(30, 35, 41, 0.7); backdrop-filter: blur(10px); border: 1px solid #2b3139; }
        .bot-card { background: #1e2329; border: 1px solid #2b3139; border-radius: 24px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }
        .bot-card:hover { border-color: #f0b90b; transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.5); }
        .input-dark { background: #161a1e; border: 1px solid #2b3139; border-radius: 12px; padding: 12px; color: white; font-size: 14px; width: 100%; }
        .input-dark:focus { border-color: #f0b90b; outline: none; box-shadow: 0 0 0 2px rgba(240, 185, 11, 0.2); }
        .profit { color: #0ecb81; }
        .loss { color: #f6465d; }
        .param-tag { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #474d57; border-radius: 10px; }
        .indicator-label { font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.6; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- 导航头部 -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-6">
            <div>
                <h1 class="text-3xl font-black text-[#f0b90b] tracking-tighter italic flex items-center">
                    <svg class="w-8 h-8 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    STRATEGY MULTI-DIM LAB
                </h1>
                <p class="text-slate-500 text-xs font-bold uppercase tracking-[0.3em] mt-2">多指标共振策略测试沙盒 (RSI + 涨幅 + 成交量)</p>
            </div>
            <button onclick="openModal()" class="bg-[#f0b90b] text-[#0b0e11] px-10 py-4 rounded-2xl font-black text-sm shadow-xl hover:brightness-110 active:scale-95 transition-all uppercase tracking-widest">
                创建多维测试方案
            </button>
        </header>

        <!-- 全局数据 -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
            <div class="glass p-6 rounded-3xl border-l-4 border-blue-500">
                <p class="indicator-label">活跃方案数</p>
                <p id="totalBots" class="text-4xl font-black mt-1">0</p>
            </div>
            <div class="glass p-6 rounded-3xl border-l-4 border-emerald-500">
                <p class="indicator-label">累计模拟净利</p>
                <p id="totalProfit" class="text-4xl font-black profit mt-1">0.00 <span class="text-sm font-normal">U</span></p>
            </div>
            <div class="glass p-6 rounded-3xl border-l-4 border-orange-500">
                <p class="indicator-label">当前最优策略</p>
                <p id="bestBot" class="text-lg font-bold text-slate-200 mt-2 truncate">---</p>
            </div>
            <div class="glass p-6 rounded-3xl border-l-4 border-indigo-500">
                <p class="indicator-label">实时 API 馈送</p>
                <div class="flex items-center mt-2">
                    <span id="apiDot" class="w-2.5 h-2.5 rounded-full bg-slate-500 mr-2"></span>
                    <span id="apiText" class="text-xs font-black uppercase text-slate-400">Ready</span>
                </div>
            </div>
        </div>

        <!-- 方案矩阵 -->
        <div id="botGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- 动态卡片 -->
        </div>
    </div>

    <!-- 配置弹窗 -->
    <div id="modal" class="fixed inset-0 bg-black/95 backdrop-blur-xl hidden flex items-center justify-center z-50 p-6">
        <div class="bg-[#1e2329] w-full max-w-2xl p-8 md:p-10 rounded-[2.5rem] border border-[#2b3139] shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black text-[#f0b90b] italic uppercase tracking-tighter">部署多指标测试项</h2>
                <button onclick="closeModal()" class="text-slate-500 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 基础设置 -->
                <div class="md:col-span-2">
                    <label class="indicator-label block mb-2">测试方案名称</label>
                    <input type="text" id="botName" class="input-dark font-bold" placeholder="例如：RSI+量能暴力做空">
                </div>
                <div>
                    <label class="indicator-label block mb-2">交易对 (BTCUSDT)</label>
                    <input type="text" id="botSymbol" class="input-dark uppercase font-black" value="VTHOUSDT">
                </div>
                <div>
                    <label class="indicator-label block mb-2">杠杆倍数 (X)</label>
                    <input type="number" id="botLev" class="input-dark font-black" value="10">
                </div>

                <!-- 指标阈值 (共振条件) -->
                <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-4 bg-blue-500/5 rounded-2xl border border-blue-500/10">
                        <label class="indicator-label block mb-1 text-blue-400">RSI 做空线</label>
                        <input type="number" id="botRsi" class="bg-transparent text-2xl font-black text-white outline-none w-full" value="95">
                    </div>
                    <div class="p-4 bg-purple-500/5 rounded-2xl border border-purple-500/10">
                        <label class="indicator-label block mb-1 text-purple-400">短线涨幅线 (%)</label>
                        <input type="number" id="botPump" class="bg-transparent text-2xl font-black text-white outline-none w-full" value="5">
                        <p class="text-[8px] text-slate-500 mt-1">1h 内涨幅需超过此值</p>
                    </div>
                    <div class="p-4 bg-yellow-500/5 rounded-2xl border border-yellow-500/10">
                        <label class="indicator-label block mb-1 text-yellow-400">成交量激增 (倍)</label>
                        <input type="number" id="botVol" class="bg-transparent text-2xl font-black text-white outline-none w-full" value="2">
                        <p class="text-[8px] text-slate-500 mt-1">当前成交量 vs 20均量</p>
                    </div>
                </div>

                <!-- 止盈止损 -->
                <div class="p-4 bg-emerald-500/5 rounded-2xl border border-emerald-500/10">
                    <label class="indicator-label block mb-1 text-emerald-400">止盈 ROI (%)</label>
                    <input type="number" id="botTp" class="bg-transparent text-2xl font-black text-white outline-none w-full" value="30">
                </div>
                <div class="p-4 bg-red-500/5 rounded-2xl border border-red-500/10">
                    <label class="indicator-label block mb-1 text-red-400">补仓触发 ROI (%)</label>
                    <input type="number" id="botAdd" class="bg-transparent text-2xl font-black text-white outline-none w-full" value="-20">
                </div>
            </div>

            <div class="flex gap-4 mt-10">
                <button onclick="closeModal()" class="flex-1 py-4 text-slate-500 font-bold uppercase text-xs">取消</button>
                <button onclick="saveBot()" class="flex-1 py-4 bg-[#f0b90b] text-[#0b0e11] rounded-2xl font-black uppercase text-sm shadow-xl active:scale-95 transition-all">开启多维测试</button>
            </div>
        </div>
    </div>

    <script>
        let bots = [];
        let marketData = {}; 
        const fapi = "https://fapi.binance.com"; 

        window.onload = () => {
            const saved = localStorage.getItem('lab_multi_v4');
            if(saved) {
                bots = JSON.parse(saved);
                renderBots();
            }
            startEngine();
        };

        function openModal() { document.getElementById('modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function saveBot() {
            const newBot = {
                id: Date.now(),
                name: document.getElementById('botName').value || "多指标方案",
                symbol: document.getElementById('botSymbol').value.toUpperCase().replace('/', ''),
                rsiLimit: parseFloat(document.getElementById('botRsi').value),
                pumpLimit: parseFloat(document.getElementById('botPump').value),
                volLimit: parseFloat(document.getElementById('botVol').value),
                lev: parseFloat(document.getElementById('botLev').value),
                tp: parseFloat(document.getElementById('botTp').value),
                addLimit: parseFloat(document.getElementById('botAdd').value),
                state: 'SCANNING', 
                pnl: 0,
                trades: 0,
                entryPrice: 0,
                totalProfit: 0,
                currentAmt: 0,
                hasAdded: false
            };
            bots.push(newBot);
            localStorage.setItem('lab_multi_v4', JSON.stringify(bots));
            renderBots();
            closeModal();
        }

        function renderBots() {
            const grid = document.getElementById('botGrid');
            grid.innerHTML = '';
            document.getElementById('totalBots').innerText = bots.length;

            if(bots.length === 0) {
                grid.innerHTML = `<div class="col-span-full py-20 text-center opacity-20 border-2 border-dashed border-slate-800 rounded-[3rem]"><p class="font-black text-slate-500 uppercase tracking-widest">请创建多指标测试方案开始对比</p></div>`;
                return;
            }

            bots.forEach(bot => {
                const data = marketData[bot.symbol] || { price: 0, rsi15: 0, rsi1h: 0, pump: 0, volRatio: 0 };
                const card = document.createElement('div');
                card.className = `bot-card p-7 shadow-2xl ${bot.state === 'HOLDING' ? 'ring-2 ring-blue-500/40 border-blue-500/20' : 'border-[#2b3139]'}`;
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="font-black text-lg tracking-tighter truncate w-32 uppercase italic text-slate-200">${bot.name}</h3>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="px-2 py-0.5 bg-yellow-900/30 text-[#f0b90b] text-[10px] font-black rounded uppercase">${bot.symbol}</span>
                                <span class="px-2 py-0.5 bg-slate-800 text-slate-400 text-[10px] font-black rounded uppercase">${bot.lev}X</span>
                            </div>
                        </div>
                        <button onclick="deleteBot(${bot.id})" class="text-slate-700 hover:text-red-500 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>

                    <!-- 动态指标监控 -->
                    <div class="grid grid-cols-3 gap-2 mb-6">
                        <div class="param-tag p-2 rounded-xl text-center">
                            <p class="indicator-label">RSI 15m</p>
                            <p class="text-sm font-black ${data.rsi15 >= bot.rsiLimit ? 'text-red-400' : 'text-slate-300'}">${data.rsi15.toFixed(1)}</p>
                        </div>
                        <div class="param-tag p-2 rounded-xl text-center">
                            <p class="indicator-label">1h 涨幅</p>
                            <p class="text-sm font-black ${data.pump >= bot.pumpLimit ? 'text-red-400' : 'text-slate-300'}">${data.pump.toFixed(1)}%</p>
                        </div>
                        <div class="param-tag p-2 rounded-xl text-center">
                            <p class="indicator-label">量激增</p>
                            <p class="text-sm font-black ${data.volRatio >= bot.volLimit ? 'text-red-400' : 'text-slate-300'}">${data.volRatio.toFixed(1)}x</p>
                        </div>
                    </div>

                    <div class="bg-black/30 p-5 rounded-2xl mb-6 flex justify-between items-center border border-white/5">
                        <div class="text-center flex-1">
                            <p class="indicator-label mb-1">ROI</p>
                            <p class="text-2xl font-black tabular-nums ${bot.pnl >= 0 ? 'profit' : 'loss'}">${bot.pnl.toFixed(2)}%</p>
                        </div>
                        <div class="w-px h-8 bg-slate-800 mx-2"></div>
                        <div class="text-center flex-1">
                            <p class="indicator-label mb-1">Net Profit</p>
                            <p class="text-2xl font-black text-slate-100">${bot.totalProfit.toFixed(2)}<span class="text-[10px] ml-1 opacity-40">U</span></p>
                        </div>
                    </div>

                    <div class="flex justify-between items-center text-[10px] font-black uppercase tracking-widest px-1">
                        <span class="text-slate-600">STATE: <span class="${bot.state === 'HOLDING' ? 'text-red-400' : 'text-blue-400'}">${bot.state}</span></span>
                        <span class="text-slate-600">成交: <span class="text-slate-300">${bot.trades}</span></span>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function deleteBot(id) {
            bots = bots.filter(b => b.id !== id);
            localStorage.setItem('lab_multi_v4', JSON.stringify(bots));
            renderBots();
        }

        function calculateRSI(closes, period = 14) {
            if (closes.length < period) return 0;
            let changes = [];
            for (let i = 1; i < closes.length; i++) changes.push(closes[i] - closes[i - 1]);
            let g = 0, l = 0;
            for (let i = 0; i < period; i++) { if (changes[i] > 0) g += changes[i]; else l -= changes[i]; }
            let ag = g/period, al = l/period;
            for (let i = period; i < changes.length; i++) {
                let cg = changes[i] > 0 ? changes[i] : 0, cl = changes[i] < 0 ? -changes[i] : 0;
                ag = (ag * (period - 1) + cg) / period; al = (al * (period - 1) + cl) / period;
            }
            return 100 - (100 / (1 + (ag / (al || 1e-9))));
        }

        async function startEngine() {
            setInterval(async () => {
                if (bots.length === 0) return;
                const uniqueSymbols = [...new Set(bots.map(b => b.symbol))];
                try {
                    for (const symbol of uniqueSymbols) {
                        // 获取 K 线数据
                        const resp = await fetch(`${fapi}/fapi/v1/klines?symbol=${symbol}&interval=15m&limit=100`).then(r => r.json());
                        const closes = resp.map(d => parseFloat(d[4]));
                        const volumes = resp.map(d => parseFloat(d[5]));
                        
                        const price = closes[closes.length-1];
                        
                        // RSI
                        const rsi15v = calculateRSI(closes);
                        
                        // 短线涨幅 (对比 1 小时前，即 4 根 15m K线)
                        const oldPrice = closes[closes.length - 5] || closes[0];
                        const pump = ((price - oldPrice) / oldPrice) * 100;
                        
                        // 成交量激增 (当前量 vs 过去 20 周期均量)
                        const currentVol = volumes[volumes.length - 1];
                        const avgVol = volumes.slice(-21, -1).reduce((a, b) => a + b, 0) / 20;
                        const volRatio = currentVol / (avgVol || 1);

                        marketData[symbol] = { price, rsi15: rsi15v, pump, volRatio };
                    }
                    
                    document.getElementById('apiDot').className = "w-2.5 h-2.5 rounded-full bg-emerald-500 animate-pulse mr-2";
                    document.getElementById('apiText').innerText = "Streaming Data";
                    document.getElementById('apiText').className = "text-xs font-black uppercase text-emerald-400";
                    
                    updateBotsLogic();
                } catch (e) {
                    document.getElementById('apiDot').className = "w-2.5 h-2.5 rounded-full bg-red-500 mr-2";
                    document.getElementById('apiText').innerText = "Connection Weak";
                }
            }, 5000);
        }

        function updateBotsLogic() {
            let totalProfitSum = 0;
            bots.forEach(bot => {
                const data = marketData[bot.symbol];
                if (!data) return;
                const { price, rsi15, pump, volRatio } = data;

                if (bot.state === 'SCANNING') {
                    bot.pnl = 0;
                    // 多维共振触发：RSI 超标 + 1h内涨幅超标 + 成交量激增
                    if (rsi15 >= bot.rsiLimit && pump >= bot.pumpLimit && volRatio >= bot.volLimit) {
                        bot.state = 'HOLDING';
                        bot.entryPrice = price;
                        bot.trades += 1;
                        bot.hasAdded = false;
                        bot.currentAmt = 1; 
                    }
                } else if (bot.state === 'HOLDING') {
                    bot.pnl = (bot.entryPrice - price) / bot.entryPrice * bot.lev * 100;

                    if (bot.pnl >= bot.tp) {
                        bot.totalProfit += (bot.currentAmt * (bot.pnl / 100)); 
                        bot.state = 'SCANNING';
                    }

                    if (bot.pnl <= bot.addLimit && !bot.hasAdded) {
                        const oldVal = bot.currentAmt * bot.lev;
                        const newVal = 2 * bot.lev; // 默认加仓 2U
                        const totalVal = oldVal + newVal;
                        const oldQty = oldVal / bot.entryPrice;
                        const newQty = newVal / price;
                        bot.entryPrice = totalVal / (oldQty + newQty);
                        bot.currentAmt += 2;
                        bot.hasAdded = true;
                    }
                    
                    if (bot.pnl <= -100) {
                        bot.totalProfit -= bot.currentAmt; 
                        bot.state = 'SCANNING';
                    }
                }
                totalProfitSum += bot.totalProfit;
            });

            if (bots.length > 0) {
                const best = bots.reduce((prev, current) => (prev.totalProfit > current.totalProfit) ? prev : current);
                document.getElementById('bestBot').innerText = best.name.toUpperCase();
                document.getElementById('totalProfit').innerText = totalProfitSum.toFixed(2);
            }
            renderBots();
        }
    </script>
</body>
</html>
