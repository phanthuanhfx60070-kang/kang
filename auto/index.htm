<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>哨兵全能版量化系统 - 多维增强</title>
    
    <!-- PWA 配置 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { 
            background-color: #0b0e11; 
            color: #eaecef; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
        }
        .app-card { background-color: #1e2329; border-radius: 20px; border: 1px solid #2b3139; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .nav-item.active { color: #f0b90b; border-top: 2px solid #f0b90b; }
        .input-dark { background-color: #161a1e; border: 1px solid #2b3139; border-radius: 12px; padding: 10px; color: white; font-size: 14px; width: 100%; }
        .input-dark:focus { border-color: #f0b90b; outline: none; }
        
        .status-tag-sim { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .status-tag-live { background: rgba(246, 70, 93, 0.15); color: #f6465d; border: 1px solid rgba(246, 70, 93, 0.3); }
        
        .profit { color: #0ecb81; }
        .loss { color: #f6465d; }
        ::-webkit-scrollbar { display: none; }
        .indicator-mini { font-size: 8px; font-weight: 900; letter-spacing: 0.05em; opacity: 0.6; }
        
        /* 按钮点击反馈 */
        .btn-active:active { transform: scale(0.96); opacity: 0.9; }
    </style>
</head>
<body class="bg-[#0b0e11]">

    <!-- 顶部导航 -->
    <div class="sticky top-0 z-50 bg-[#0b0e11]/90 backdrop-blur-xl border-b border-[#2b3139] px-6 pb-3 pt-[calc(env(safe-area-inset-top)+12px)] flex justify-between items-center text-center">
        <div class="text-left">
            <h1 class="text-xl font-black text-[#f0b90b] tracking-tighter italic">SENTINEL AIO</h1>
            <p id="globalStatus" class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">System Ready</p>
        </div>
        <button onclick="openModal()" class="bg-[#f0b90b] text-[#0b0e11] px-5 py-2 rounded-full font-black text-xs shadow-lg btn-active transition-all">
            + 部署多维策略
        </button>
    </div>

    <!-- 主容器 -->
    <main class="px-4 pt-4 pb-32 max-w-5xl mx-auto">
        
        <!-- Tab 1: 策略矩阵 -->
        <section id="tab-lab" class="tab-content active space-y-6">
            <div class="grid grid-cols-2 gap-4">
                <div class="app-card p-4 text-center border-l-4 border-blue-500 shadow-lg">
                    <p class="indicator-mini uppercase">总模拟获利</p>
                    <p id="totalSimPnl" class="text-xl font-black profit">0.00 U</p>
                </div>
                <div class="app-card p-4 text-center border-l-4 border-red-500 shadow-lg">
                    <p class="indicator-mini uppercase">实盘账户余额 (USDT)</p>
                    <p id="liveBalance" class="text-xl font-black text-slate-200">--</p>
                </div>
            </div>

            <div id="strategyGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 动态卡片 -->
                <div class="col-span-full py-20 text-center opacity-30 border-2 border-dashed border-slate-800 rounded-3xl">
                    <p class="text-sm font-bold uppercase tracking-widest">No strategies deployed</p>
                </div>
            </div>
        </section>

        <!-- Tab 2: 账户设置 -->
        <section id="tab-account" class="tab-content space-y-6">
            <div class="app-card p-6 shadow-xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-sm font-black text-[#f0b90b] uppercase tracking-widest italic">API Security Center</h3>
                    <span id="connTestLabel" class="text-[9px] font-black uppercase text-slate-600 tracking-tighter">Not Tested</span>
                </div>
                
                <div class="space-y-5">
                    <div>
                        <label class="text-[10px] text-slate-500 font-bold uppercase block mb-1">API Key</label>
                        <input type="password" id="apiKey" class="input-dark" placeholder="Enter Binance API Key">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 font-bold uppercase block mb-1">Secret Key</label>
                        <input type="password" id="apiSecret" class="input-dark" placeholder="Enter Binance Secret Key">
                    </div>
                    <div class="p-4 bg-blue-500/5 border border-blue-500/10 rounded-xl">
                        <p class="text-[10px] text-blue-400 font-bold uppercase italic mb-1">API Endpoint / Proxy</p>
                        <input type="text" id="apiBase" class="input-dark text-xs mt-1" value="https://fapi.binance.com">
                        <p class="text-[8px] text-slate-600 mt-2 italic">* 必须配合浏览器跨域(CORS)插件才能正常连接</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 pt-2">
                        <button onclick="testConnection()" class="py-3 bg-slate-800 text-slate-300 font-black rounded-xl uppercase text-xs btn-active border border-slate-700">测试连接</button>
                        <button id="saveKeysBtn" onclick="saveKeys()" class="py-3 bg-[#f0b90b] text-[#0b0e11] font-black rounded-xl uppercase text-xs shadow-lg btn-active">保存配置</button>
                    </div>
                </div>
            </div>

            <div class="app-card p-4">
                <p class="text-[10px] text-red-500/70 font-bold uppercase tracking-widest mb-2">安全须知</p>
                <p class="text-[10px] text-slate-500 leading-relaxed font-medium">
                    • 密钥保存在本地 Storage，清除浏览器缓存即丢失。<br>
                    • 强烈建议在币安后台设置【API IP白名单】。<br>
                    • 建议 API 权限仅开启【合约读取】与【允许合约交易】。
                </p>
            </div>
        </section>

        <!-- Tab 3: 系统日志 -->
        <section id="tab-logs" class="tab-content">
            <div class="app-card p-4 h-[65vh] flex flex-col shadow-inner">
                <div class="flex justify-between items-center mb-3">
                    <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Engine Runtime Activity</p>
                    <button onclick="document.getElementById('logs').innerHTML=''" class="text-[9px] text-slate-700 font-bold underline">CLEAR</button>
                </div>
                <div id="logs" class="flex-1 overflow-y-auto text-[10px] font-mono leading-relaxed bg-black/30 rounded-xl p-3 scroll-smooth">
                    <div class="text-slate-700 italic">> 哨兵系统 (多维增强 AIO) 就绪...</div>
                </div>
            </div>
        </section>
    </main>

    <!-- 底部导航 -->
    <nav class="fixed bottom-0 left-0 right-0 bg-[#1e2329]/95 backdrop-blur-md border-t border-white/5 px-8 pt-3 pb-[calc(env(safe-area-inset-bottom)+12px)] flex justify-between items-center z-50">
        <button onclick="showTab('lab')" class="nav-item active flex flex-col items-center gap-1 transition-all text-slate-500">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
            <span class="text-[9px] font-black uppercase">Board</span>
        </button>
        <button onclick="showTab('account')" class="nav-item flex flex-col items-center gap-1 transition-all text-slate-500">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
            <span class="text-[9px] font-black uppercase">Security</span>
        </button>
        <button onclick="showTab('logs')" class="nav-item flex flex-col items-center gap-1 transition-all text-slate-500">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            <span class="text-[9px] font-black uppercase">Logs</span>
        </button>
    </nav>

    <!-- 配置弹窗 -->
    <div id="modal" class="fixed inset-0 bg-black/95 backdrop-blur-xl hidden flex items-center justify-center z-[100] p-6">
        <div class="bg-[#1e2329] w-full max-w-lg p-8 rounded-[2rem] border border-[#2b3139] shadow-2xl overflow-y-auto max-h-[85vh]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black text-[#f0b90b] italic uppercase tracking-tight">Deploy Strategy</h2>
                <button onclick="closeModal()" class="text-slate-500 text-2xl font-bold">&times;</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="indicator-mini block mb-1">备注名称</label>
                    <input type="text" id="botName" class="input-dark font-bold" placeholder="方案 A">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="indicator-mini block mb-1">交易对</label>
                        <input type="text" id="botSymbol" class="input-dark uppercase font-black" value="VTHOUSDT">
                    </div>
                    <div>
                        <label class="indicator-mini block mb-1">杠杆倍数 (X)</label>
                        <input type="number" id="botLev" class="input-dark font-black" value="10">
                    </div>
                </div>
                
                <!-- 三维参数 -->
                <div class="grid grid-cols-3 gap-3">
                    <div class="p-3 bg-blue-500/5 rounded-xl border border-blue-500/10">
                        <label class="text-[8px] text-blue-400 font-black uppercase block mb-1">RSI 线</label>
                        <input type="number" id="botRsi" class="bg-transparent text-lg font-black text-white outline-none w-full" value="97">
                    </div>
                    <div class="p-3 bg-purple-500/5 rounded-xl border border-purple-500/10">
                        <label class="text-[8px] text-purple-400 font-black uppercase block mb-1">1h 涨幅 %</label>
                        <input type="number" id="botPump" class="bg-transparent text-lg font-black text-white outline-none w-full" value="5">
                    </div>
                    <div class="p-3 bg-yellow-500/5 rounded-xl border border-yellow-500/10">
                        <label class="text-[8px] text-yellow-400 font-black uppercase block mb-1">量能倍数</label>
                        <input type="number" id="botVol" class="bg-transparent text-lg font-black text-white outline-none w-full" value="2">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 pt-2">
                    <div class="p-4 bg-emerald-500/5 rounded-2xl border border-emerald-500/10 text-center">
                        <label class="text-[9px] text-emerald-400 font-black uppercase mb-1 block">止盈 ROI (%)</label>
                        <input type="number" id="botTp" class="bg-transparent text-xl font-black text-white outline-none w-full text-center" value="30">
                    </div>
                    <div class="p-4 bg-red-500/5 rounded-2xl border border-red-500/10 text-center">
                        <label class="text-[9px] text-red-400 font-black uppercase mb-1 block">补仓触发 (%)</label>
                        <input type="number" id="botAdd" class="bg-transparent text-xl font-black text-white outline-none w-full text-center" value="-20">
                    </div>
                </div>

                <div class="flex gap-4 pt-6">
                    <button onclick="closeModal()" class="flex-1 py-4 text-slate-500 font-black uppercase text-xs">取消</button>
                    <button onclick="saveBot()" class="flex-1 py-4 bg-[#f0b90b] text-[#0b0e11] rounded-2xl font-black uppercase text-sm shadow-xl btn-active transition-all">部署策略</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 告警音 -->
    <audio id="alert" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <script>
        let strategies = [];
        let marketFeed = {}; 
        const DEFAULT_API_BASE = "https://fapi.binance.com";

        window.onload = () => {
            const saved = localStorage.getItem('sentinel_v6_strategies');
            if(saved) { strategies = JSON.parse(saved); renderStrategies(); }
            
            const k = localStorage.getItem('s_api_k');
            const s = localStorage.getItem('s_api_s');
            const b = localStorage.getItem('s_api_b');
            
            if(k) document.getElementById('apiKey').value = k;
            if(s) document.getElementById('apiSecret').value = s;
            if(b) document.getElementById('apiBase').value = b;
            
            startMainLoop();
        };

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active', 'text-[#f0b90b]'));
            document.getElementById(`tab-${id}`).classList.add('active');
            event.currentTarget.classList.add('active', 'text-[#f0b90b]');
        }

        function openModal() { document.getElementById('modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function saveBot() {
            const bot = {
                id: Date.now(),
                name: document.getElementById('botName').value || "方案 " + (strategies.length+1),
                symbol: document.getElementById('botSymbol').value.toUpperCase().trim(),
                rsiLimit: parseFloat(document.getElementById('botRsi').value),
                pumpLimit: parseFloat(document.getElementById('botPump').value),
                volLimit: parseFloat(document.getElementById('botVol').value),
                lev: parseFloat(document.getElementById('botLev').value),
                tp: parseFloat(document.getElementById('botTp').value),
                addLimit: parseFloat(document.getElementById('botAdd').value),
                isLive: false,
                state: 'IDLE',
                pnl: 0,
                entryPrice: 0,
                totalProfit: 0,
                currentAmtU: 0,
                hasAdded: false
            };
            strategies.push(bot);
            saveData(); renderStrategies(); closeModal();
        }

        function saveData() { localStorage.setItem('sentinel_v6_strategies', JSON.stringify(strategies)); }

        function saveKeys() {
            const k = document.getElementById('apiKey').value.trim();
            const s = document.getElementById('apiSecret').value.trim();
            const b = document.getElementById('apiBase').value.trim();
            
            localStorage.setItem('s_api_k', k);
            localStorage.setItem('s_api_s', s);
            localStorage.setItem('s_api_b', b);
            
            const btn = document.getElementById('saveKeysBtn');
            const originalText = btn.innerText;
            btn.innerText = "已保存 ✔";
            btn.classList.replace('bg-[#f0b90b]', 'bg-emerald-500');
            
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.replace('bg-emerald-500', 'bg-[#f0b90b]');
            }, 1500);
            
            addLog("API 配置成功并持久化保存", "text-emerald-400 font-black");
        }

        async function testConnection() {
            const apiBase = (document.getElementById('apiBase').value || DEFAULT_API_BASE).trim().replace(/\/$/, "");
            const label = document.getElementById('connTestLabel');
            label.innerText = "Testing...";
            label.className = "text-[9px] font-black uppercase text-blue-400 tracking-tighter";

            try {
                const resp = await fetch(`${apiBase}/fapi/v1/ping`);
                if(resp.ok) {
                    label.innerText = "Connected";
                    label.className = "text-[9px] font-black uppercase text-emerald-400 tracking-tighter";
                    addLog("网络测试：成功连接至币安节点", "text-emerald-400");
                } else {
                    throw new Error("HTTP " + resp.status);
                }
            } catch (e) {
                label.innerText = "Error";
                label.className = "text-[9px] font-black uppercase text-red-500 tracking-tighter";
                addLog("网络测试：失败，请检查 VPN 或 CORS 插件", "text-red-500 font-bold");
            }
        }

        function toggleMode(id) {
            const bot = strategies.find(s => s.id === id);
            if(!bot) return;
            
            const savedK = localStorage.getItem('s_api_k');
            if(!savedK && !bot.isLive) {
                showTab('account');
                return alert("请先在 Security 页面输入并保存 API Key");
            }
            
            bot.isLive = !bot.isLive;
            addLog(`策略 ${bot.name} 模式：${bot.isLive ? '实盘执行' : '模拟测试'}`, bot.isLive ? 'text-red-500 font-bold' : 'text-blue-400');
            saveData(); renderStrategies();
        }

        function deleteBot(id) { strategies = strategies.filter(s => s.id !== id); saveData(); renderStrategies(); }

        async function startMainLoop() {
            setInterval(async () => {
                if(strategies.length === 0) return;
                const uniqueSymbols = [...new Set(strategies.map(s => s.symbol))];
                const apiBase = (localStorage.getItem('s_api_b') || DEFAULT_API_BASE).replace(/\/$/, "");
                
                try {
                    for(const sym of uniqueSymbols) {
                        const resp = await fetch(`${apiBase}/fapi/v1/klines?symbol=${sym}&interval=15m&limit=100`).then(r => r.json());
                        const closes = resp.map(d => parseFloat(d[4]));
                        const volumes = resp.map(d => parseFloat(d[5]));
                        const price = closes[closes.length-1];
                        
                        const rsi15 = calculateRSI(closes);
                        const resp1h = await fetch(`${apiBase}/fapi/v1/klines?symbol=${sym}&interval=1h&limit=100`).then(r => r.json());
                        const rsi1h = calculateRSI(resp1h.map(d => parseFloat(d[4])));
                        
                        const oldPrice = closes[closes.length-5] || closes[0];
                        const pump = ((price - oldPrice) / oldPrice) * 100;
                        
                        const currentVol = volumes[volumes.length-1];
                        const avgVol = volumes.slice(-21, -1).reduce((a,b)=>a+b,0) / 20;
                        const volRatio = currentVol / (avgVol || 1);

                        marketFeed[sym] = { price, rsi15, rsi1h, pump, volRatio };
                    }
                    document.getElementById('globalStatus').innerText = "Streaming Data Ready";
                    document.getElementById('globalStatus').className = "text-[9px] font-bold text-emerald-400 uppercase tracking-widest";
                    updateLogic();
                    
                    if(strategies.some(s => s.isLive)) refreshBalance();
                } catch (e) {
                    document.getElementById('globalStatus').innerText = "Network Blocked";
                    document.getElementById('globalStatus').className = "text-[9px] font-bold text-red-500 uppercase tracking-widest";
                }
            }, 8000);
        }

        async function refreshBalance() {
            try {
                const balData = await signedRequest('GET', '/fapi/v2/balance');
                if(Array.isArray(balData)) {
                    const usdt = balData.find(b => b.asset === 'USDT');
                    document.getElementById('liveBalance').innerText = parseFloat(usdt.balance).toFixed(2);
                }
            } catch (e) {}
        }

        function calculateRSI(closes, period = 14) {
            let changes = [];
            for (let i = 1; i < closes.length; i++) changes.push(closes[i] - closes[i - 1]);
            let g = 0, l = 0;
            for (let i = 0; i < period; i++) { if (changes[i] > 0) g += changes[i]; else l -= changes[i]; }
            let ag = g/period, al = l/period;
            for (let i = period; i < changes.length; i++) {
                let cg = changes[i] > 0 ? changes[i] : 0, cl = changes[i] < 0 ? -changes[i] : 0;
                ag = (ag * (period - 1) + cg) / period; al = (al * (period - 1) + cl) / period;
            }
            return 100 - (100 / (1 + (ag / (al || 1e-9))));
        }

        async function updateLogic() {
            let totalSim = 0;
            for(const bot of strategies) {
                const feed = marketFeed[bot.symbol];
                if(!feed) continue;
                
                if(bot.isLive) {
                    await processLiveBot(bot, feed);
                } else {
                    processSimBot(bot, feed);
                }
                totalSim += bot.totalProfit;
            }
            document.getElementById('totalSimPnl').innerText = totalSim.toFixed(2) + " U";
            renderStrategies();
        }

        function processSimBot(bot, feed) {
            const { price, rsi15, rsi1h, pump, volRatio } = feed;
            if(bot.state === 'IDLE') {
                if(rsi15 >= bot.rsiLimit && rsi1h >= bot.rsiLimit && pump >= bot.pumpLimit && volRatio >= bot.volLimit) {
                    bot.state = 'HOLDING'; bot.entryPrice = price; bot.currentAmtU = 1; bot.hasAdded = false; bot.pnl = 0;
                    addLog(`[Sim] ${bot.name} 触发共振 - 开空`, 'text-blue-400 font-bold');
                    document.getElementById('alert').play();
                }
            } else {
                bot.pnl = (bot.entryPrice - price) / bot.entryPrice * bot.lev * 100;
                if(bot.pnl >= bot.tp) {
                    bot.totalProfit += (bot.currentAmtU * bot.tp / 100); bot.state = 'IDLE'; bot.pnl = 0;
                    addLog(`[Sim] ${bot.name} 达到目标止盈`, 'text-emerald-400 font-bold');
                } else if(bot.pnl <= bot.addLimit && !bot.hasAdded) {
                    bot.entryPrice = (bot.entryPrice * 1 + price * 2) / 3; bot.currentAmtU = 3; bot.hasAdded = true;
                    addLog(`[Sim] ${bot.name} 触发阈值补仓`, 'text-orange-400');
                } else if(bot.pnl <= -100) { 
                    bot.totalProfit -= bot.currentAmtU; bot.state = 'IDLE'; bot.pnl = 0;
                    addLog(`[Sim] ${bot.name} 模拟爆仓`, 'text-red-500 font-black');
                }
            }
        }

        // --- 实盘下单执行逻辑 ---
        async function processLiveBot(bot, feed) {
            const { price, rsi15, rsi1h, pump, volRatio } = feed;
            
            try {
                // 1. 获取实盘持仓
                const positions = await signedRequest('GET', '/fapi/v2/positionRisk', { symbol: bot.symbol });
                const pos = positions.find(p => p.symbol === bot.symbol);
                const currentAmt = parseFloat(pos.positionAmt); // 实盘空单数量为负数
                const entry = parseFloat(pos.entryPrice);
                
                if (currentAmt === 0) {
                    // --- 实盘未持仓：判断是否入场 ---
                    bot.state = 'IDLE';
                    bot.pnl = 0;
                    if (rsi15 >= bot.rsiLimit && rsi1h >= bot.rsiLimit && pump >= bot.pumpLimit && volRatio >= bot.volLimit) {
                        addLog(`[Live] ${bot.name} 满足共振条件，准备实盘下单...`, 'text-red-400 font-black');
                        
                        // 计算下单量 (按 1U * 杠杆)
                        let qty = Math.floor((1 * bot.lev) / price);
                        if(qty < 1) qty = 1; // 针对低价币取整保护
                        
                        const order = await placeOrder(bot.symbol, 'SELL', qty, bot.lev);
                        if(order.orderId) {
                            addLog(`[Live] 实盘开空成功！数量: ${qty}`, 'text-emerald-400 font-black');
                            document.getElementById('alert').play();
                        }
                    }
                } else {
                    // --- 实盘持仓中：监控盈亏执行策略 ---
                    bot.state = 'HOLDING';
                    // 空单 ROI 计算
                    const roi = (entry - price) / entry * bot.lev * 100;
                    bot.pnl = roi;
                    bot.entryPrice = entry;

                    // A. 止盈逻辑
                    if (roi >= bot.tp) {
                        addLog(`[Live] 实盘收益 ${roi.toFixed(1)}% 达标止盈中...`, 'text-emerald-400 font-black');
                        const closeOrder = await placeOrder(bot.symbol, 'BUY', Math.abs(currentAmt), bot.lev);
                        if(closeOrder.orderId) addLog(`[Live] 实盘止盈平仓成功`, 'text-emerald-400 font-black');
                    }
                    
                    // B. 补仓逻辑 (此处模拟加仓 2U)
                    if (roi <= bot.addLimit && !bot.hasAdded) {
                        addLog(`[Live] 实盘亏损 ${roi.toFixed(1)}% 触发补仓...`, 'text-orange-400 font-black');
                        let addQty = Math.floor((2 * bot.lev) / price);
                        const addOrder = await placeOrder(bot.symbol, 'SELL', addQty, bot.lev);
                        if(addOrder.orderId) {
                            bot.hasAdded = true;
                            addLog(`[Live] 实盘补仓成功`, 'text-orange-400 font-black');
                        }
                    }
                }
            } catch (e) {
                console.error("Live Logic Error:", e);
            }
        }

        async function placeOrder(symbol, side, qty, leverage) {
            try {
                // 设置杠杆
                await signedRequest('POST', '/fapi/v1/leverage', { symbol, leverage });
                // 下市价单
                return await signedRequest('POST', '/fapi/v1/order', {
                    symbol,
                    side,
                    type: 'MARKET',
                    quantity: qty
                });
            } catch (e) {
                addLog(`[Trade Error] 下单失败: ${e.message}`, 'text-red-500');
                return {};
            }
        }

        function renderStrategies() {
            const grid = document.getElementById('strategyGrid');
            if(strategies.length === 0) return;
            
            let newHTML = '';
            strategies.forEach(bot => {
                const feed = marketFeed[bot.symbol] || { price: 0, rsi15: 0, rsi1h: 0, pump: 0, volRatio: 0 };
                const displayPnl = (bot.pnl || 0).toFixed(2);
                
                newHTML += `
                    <div class="app-card p-5 relative overflow-hidden transition-all shadow-md ${bot.state === 'HOLDING' ? 'ring-1 ring-white/20' : ''}">
                        <div class="flex justify-between items-start mb-5">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <h3 class="font-black text-sm italic text-slate-100 truncate w-24 uppercase tracking-tighter">${bot.name}</h3>
                                    <span class="px-2 py-0.5 rounded-[5px] text-[8px] font-black uppercase ${bot.isLive ? 'status-tag-live animate-pulse' : 'status-tag-sim'}">
                                        ${bot.isLive ? '● Live' : 'Sim Mode'}
                                    </span>
                                </div>
                                <div class="mt-2 flex flex-wrap gap-1.5">
                                    <span class="px-1.5 py-0.5 bg-slate-800 text-slate-400 text-[8px] font-black rounded uppercase">${bot.symbol} ${bot.lev}X</span>
                                    <span class="text-[8px] text-blue-500 font-bold uppercase">Target RSI:${bot.rsiLimit}</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="relative inline-flex items-center cursor-pointer scale-75">
                                    <input type="checkbox" ${bot.isLive ? 'checked' : ''} onchange="toggleMode(${bot.id})" class="sr-only peer">
                                    <div class="w-7 h-4 bg-slate-800 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-red-500"></div>
                                </label>
                                <button onclick="deleteBot(${bot.id})" class="text-slate-700 hover:text-red-500 p-1 transition-colors">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/></svg>
                                </button>
                            </div>
                        </div>

                        <div class="bg-black/30 p-4 rounded-xl mb-4 border border-white/5 flex justify-between items-center text-center">
                            <div class="flex-1">
                                <p class="indicator-mini mb-1">Current ROI</p>
                                <p class="text-lg font-black tabular-nums ${bot.pnl >= 0 ? 'profit' : 'loss'}">
                                    ${bot.state === 'HOLDING' ? displayPnl + '%' : '0.00%'}
                                </p>
                            </div>
                            <div class="w-px h-6 bg-slate-800 mx-2"></div>
                            <div class="flex-1">
                                <p class="indicator-mini mb-1">Total Net</p>
                                <p class="text-lg font-black text-slate-100">${(bot.totalProfit || 0).toFixed(2)}<span class="text-[9px] opacity-40 ml-0.5">U</span></p>
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-2 bg-[#161a1e] p-2.5 rounded-xl text-[9px] font-bold">
                            <div class="text-center">
                                <span class="text-slate-500 block uppercase mb-1">RSI (15m)</span>
                                <span class="${feed.rsi15 >= bot.rsiLimit ? 'text-red-500 animate-pulse' : 'text-slate-200'}">${feed.rsi15.toFixed(1)}</span>
                            </div>
                            <div class="text-center border-x border-white/5">
                                <span class="text-slate-500 block uppercase mb-1">Pump (1h)</span>
                                <span class="${feed.pump >= bot.pumpLimit ? 'text-red-500' : 'text-slate-200'}">${feed.pump.toFixed(1)}%</span>
                            </div>
                            <div class="text-center">
                                <span class="text-slate-500 block uppercase mb-1">Volume X</span>
                                <span class="${feed.volRatio >= bot.volLimit ? 'text-red-500' : 'text-slate-200'}">${feed.volRatio.toFixed(1)}x</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            grid.innerHTML = newHTML;
        }

        function addLog(msg, colorClass = 'text-slate-500') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `border-b border-white/5 py-2 ${colorClass}`;
            entry.innerHTML = `<span class="opacity-30 mr-2 text-[8px]">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
            logs.prepend(entry);
        }

        async function signedRequest(method, endpoint, params = {}) {
            const key = localStorage.getItem('s_api_k');
            const secret = localStorage.getItem('s_api_s');
            const base = (localStorage.getItem('s_api_b') || DEFAULT_API_BASE).replace(/\/$/, "");
            if(!key || !secret) return { msg: "API Keys missing" };
            
            const timestamp = Date.now();
            let query = Object.keys(params).map(k => `${k}=${params[k]}`).join('&');
            query += (query ? '&' : '') + `timestamp=${timestamp}&recvWindow=10000`;
            const signature = CryptoJS.HmacSHA256(query, secret).toString(CryptoJS.enc.Hex);
            
            return await fetch(`${base}${endpoint}?${query}&signature=${signature}`, {
                method, headers: { 'X-MBX-APIKEY': key }
            }).then(r => r.json());
        }
    </script>
</body>
</html>
