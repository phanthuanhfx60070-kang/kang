<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto RSI å…¨è‡ªåŠ¨åˆçº¦äº¤æ˜“ç³»ç»Ÿ - ç›ˆäºç­–ç•¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; }
        .card { background-color: #1e293b; border: 1px solid #334155; transition: all 0.3s ease; }
        .log-container { background-color: #020617; font-family: 'Courier New', monospace; }
        .rsi-critical { color: #f87171; font-weight: 800; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .trade-active { border-color: #3b82f6; box-shadow: 0 0 20px rgba(59, 130, 246, 0.15); }
        .roi-positive { color: #10b981; }
        .roi-negative { color: #ef4444; }
    </style>
</head>
<body class="p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-500">
                    RSI Auto-Trader Pro
                </h1>
                <p class="text-slate-400 text-xs mt-1">ç­–ç•¥ï¼š+30% æ­¢ç›ˆ | -20% è¡¥ä»“ | RSI 97 å…¥åœº</p>
            </div>
            <div id="statusIndicator" class="flex items-center bg-slate-800 px-4 py-2 rounded-full border border-slate-700">
                <span class="w-3 h-3 rounded-full bg-slate-500 mr-2" id="statusDot"></span>
                <span class="text-sm font-medium" id="statusText">ç³»ç»Ÿå¾…å‘½</span>
            </div>
        </header>

        <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">
            <!-- é…ç½®é¢æ¿ -->
            <div class="xl:col-span-1 space-y-4">
                <div class="card p-5 rounded-2xl shadow-xl">
                    <h2 class="text-sm font-bold mb-4 text-blue-300 uppercase tracking-widest text-center">API å¯†é’¥é…ç½®</h2>
                    <div class="space-y-3">
                        <input type="password" id="apiKey" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-xs outline-none focus:border-blue-500" placeholder="Binance API Key">
                        <input type="password" id="apiSecret" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-xs outline-none focus:border-blue-500" placeholder="Binance Secret Key">
                        <div class="flex items-center gap-2 mt-2">
                            <input type="checkbox" id="saveConfig" checked>
                            <label class="text-[10px] text-slate-500">æœ¬åœ°åŠ å¯†ä¿å­˜å¯†é’¥</label>
                        </div>
                    </div>
                </div>

                <div class="card p-5 rounded-2xl shadow-xl border-t-2 border-orange-500/50">
                    <h2 class="text-sm font-bold mb-4 text-orange-300 uppercase tracking-widest text-center">æ ¸å¿ƒç­–ç•¥å‚æ•°</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-[10px] text-slate-500 uppercase mb-1 font-bold">äº¤æ˜“å¯¹ (å¸å®‰åˆçº¦ä»£ç )</label>
                            <input type="text" id="symbolInput" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm uppercase text-blue-400 font-mono" value="VTHOUSDT">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="bg-slate-900/50 p-2 rounded-lg">
                                <label class="block text-[9px] text-slate-500 uppercase mb-1">RSI å…¥åœºçº¿</label>
                                <input type="number" id="buyThreshold" class="w-full bg-transparent text-white font-bold text-sm outline-none" value="97">
                            </div>
                            <div class="bg-slate-900/50 p-2 rounded-lg">
                                <label class="block text-[9px] text-slate-500 uppercase mb-1">æ æ†å€æ•°</label>
                                <input type="number" id="leverageInput" class="w-full bg-transparent text-white font-bold text-sm outline-none" value="10">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="bg-green-900/20 p-2 rounded-lg border border-green-900/30">
                                <label class="block text-[9px] text-green-500 uppercase mb-1 font-bold">ç›®æ ‡æ”¶ç›Š (æ­¢ç›ˆ)</label>
                                <div class="flex items-center"><input type="number" id="targetROI" class="w-full bg-transparent text-green-400 font-bold text-sm outline-none" value="30"><span class="text-xs text-green-700">%</span></div>
                            </div>
                            <div class="bg-red-900/20 p-2 rounded-lg border border-red-900/30">
                                <label class="block text-[9px] text-red-500 uppercase mb-1 font-bold">è¡¥ä»“è§¦å‘ (ROI)</label>
                                <div class="flex items-center"><input type="number" id="addThreshold" class="w-full bg-transparent text-red-400 font-bold text-sm outline-none" value="-20"><span class="text-xs text-red-700">%</span></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="bg-slate-900/50 p-2 rounded-lg">
                                <label class="block text-[9px] text-slate-500 uppercase mb-1">åˆå§‹é‡‘é¢(U)</label>
                                <input type="number" id="initAmount" class="w-full bg-transparent text-white font-bold text-sm outline-none" value="1">
                            </div>
                            <div class="bg-slate-900/50 p-2 rounded-lg">
                                <label class="block text-[9px] text-slate-500 uppercase mb-1">åŠ ä»“é‡‘é¢(U)</label>
                                <input type="number" id="addAmount" class="w-full bg-transparent text-white font-bold text-sm outline-none" value="2">
                            </div>
                        </div>
                        <button id="runBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-blue-900/40">å¯åŠ¨è‡ªåŠ¨æœºå™¨äºº</button>
                        <button id="stopBtn" class="hidden w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-xl transition-all">åœæ­¢å¹¶å¹³ä»“</button>
                    </div>
                </div>

                <div class="card p-4 rounded-2xl">
                    <div id="logPanel" class="log-container h-40 overflow-y-auto text-[10px] p-2 rounded-lg space-y-1 scroll-smooth">
                        <div class="text-slate-600">ç³»ç»Ÿå°±ç»ªï¼Œè¯·å¡«å†™ API åå¯åŠ¨...</div>
                    </div>
                </div>
            </div>

            <!-- ç›‘æ§ä¸­å¿ƒ -->
            <div class="xl:col-span-3 space-y-6">
                <div id="tradingGrid" class="grid grid-cols-1 gap-6">
                    <div class="card p-20 rounded-3xl text-center opacity-40 border-dashed">
                        ç­‰å¾…å¼•æ“åˆå§‹åŒ–æ•°æ®...
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="card p-4 rounded-2xl border-l-4 border-blue-500">
                        <p class="text-[10px] text-slate-500 uppercase font-bold">åˆçº¦è´¦æˆ·å¯ç”¨ä½™é¢</p>
                        <p id="balanceDisplay" class="text-xl font-bold text-slate-200">-- USDT</p>
                    </div>
                    <div class="card p-4 rounded-2xl border-l-4 border-orange-500">
                        <p class="text-[10px] text-slate-500 uppercase font-bold">æŒä»“å…¥åœºä»·æ ¼</p>
                        <p id="entryPriceDisplay" class="text-xl font-bold text-slate-200">--</p>
                    </div>
                    <div class="card p-4 rounded-2xl border-l-4 border-purple-500">
                        <p class="text-[10px] text-slate-500 uppercase font-bold">å½“å‰å›æŠ¥ç‡ (ROI)</p>
                        <p id="roiDisplay" class="text-xl font-bold text-slate-200">-- %</p>
                    </div>
                    <div class="card p-4 rounded-2xl border-l-4 border-emerald-500">
                        <p class="text-[10px] text-slate-500 uppercase font-bold">è¡¥ä»“è®¡æ•°å™¨</p>
                        <p id="addCounter" class="text-xl font-bold text-slate-200">0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <audio id="alertAudio" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        let isRunning = false;
        let scanTimer = null;
        let isHolding = false;
        let hasAddedForCurrentDrop = false; // åŠ ä»“é”ï¼Œé˜²æ­¢ ROI ä½äº-20%æ—¶é‡å¤ä¸‹å•
        const fapiBase = "https://fapi.binance.com";

        window.onload = () => {
            const savedKey = localStorage.getItem('rsi_api_key');
            const savedSecret = localStorage.getItem('rsi_api_secret');
            if(savedKey) document.getElementById('apiKey').value = savedKey;
            if(savedSecret) document.getElementById('apiSecret').value = savedSecret;
        };

        function sign(queryString, secret) {
            return CryptoJS.HmacSHA256(queryString, secret).toString(CryptoJS.enc.Hex);
        }

        async function privateRequest(method, endpoint, params = {}) {
            const key = document.getElementById('apiKey').value;
            const secret = document.getElementById('apiSecret').value;
            if(!key || !secret) throw new Error("ç¼ºå°‘ API Key/Secret");

            const timestamp = Date.now();
            let query = Object.keys(params).map(k => `${encodeURIComponent(k)}=${encodeURIComponent(params[k])}`).join('&');
            query += (query ? '&' : '') + `timestamp=${timestamp}&recvWindow=10000`;
            const signature = sign(query, secret);
            const url = `${fapiBase}${endpoint}?${query}&signature=${signature}`;

            const response = await fetch(url, {
                method: method,
                headers: { 'X-MBX-APIKEY': key }
            });
            return await response.json();
        }

        function calculateRSI(closes, period = 14) {
            let changes = [];
            for (let i = 1; i < closes.length; i++) changes.push(closes[i] - closes[i - 1]);
            let gains = 0, losses = 0;
            for (let i = 0; i < period; i++) {
                if (changes[i] > 0) gains += changes[i]; else losses -= changes[i];
            }
            let avgGain = gains / period, avgLoss = losses / period;
            for (let i = period; i < changes.length; i++) {
                let currentGain = changes[i] > 0 ? changes[i] : 0;
                let currentLoss = changes[i] < 0 ? -changes[i] : 0;
                avgGain = (avgGain * (period - 1) + currentGain) / period;
                avgLoss = (avgLoss * (period - 1) + currentLoss) / period;
            }
            return 100 - (100 / (1 + (avgGain / (avgLoss || 1e-9))));
        }

        async function executeTrade(symbol, side, quantity) {
            try {
                const leverage = document.getElementById('leverageInput').value;
                await privateRequest('POST', '/fapi/v1/leverage', { symbol, leverage });
                
                const order = await privateRequest('POST', '/fapi/v1/order', {
                    symbol: symbol,
                    side: side,
                    type: 'MARKET',
                    quantity: quantity
                });
                
                if(order.orderId) {
                    log(`âœ… ${side === 'BUY' ? 'ä¸‹å•' : 'å¹³ä»“'}æˆåŠŸ | ID: ${order.orderId}`, 'text-emerald-400 font-bold');
                    return true;
                } else {
                    log(`âŒ äº¤æ˜“æ‹’ç»: ${order.msg}`, 'text-red-400');
                    return false;
                }
            } catch (e) {
                log(`âŒ äº¤æ˜“å¼‚å¸¸: ${e.message}`, 'text-red-400');
                return false;
            }
        }

        function log(msg, color = 'text-slate-500') {
            const panel = document.getElementById('logPanel');
            panel.innerHTML += `<div class="${color}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            panel.scrollTop = panel.scrollHeight;
        }

        async function updateLogic() {
            const symbol = document.getElementById('symbolInput').value.toUpperCase();
            const buyLimit = parseFloat(document.getElementById('buyThreshold').value);
            const targetROI = parseFloat(document.getElementById('targetROI').value);
            const addThreshold = parseFloat(document.getElementById('addThreshold').value);
            
            const initU = parseFloat(document.getElementById('initAmount').value);
            const addU = parseFloat(document.getElementById('addAmount').value);
            const lev = parseFloat(document.getElementById('leverageInput').value);

            try {
                // 1. è·å–è¡Œæƒ…
                const [r15, r1h] = await Promise.all([
                    fetch(`${fapiBase}/fapi/v1/klines?symbol=${symbol}&interval=15m&limit=500`).then(r => r.json()),
                    fetch(`${fapiBase}/fapi/v1/klines?symbol=${symbol}&interval=1h&limit=500`).then(r => r.json())
                ]);

                const closes15 = r15.map(d => parseFloat(d[4]));
                const closes1h = r1h.map(d => parseFloat(d[4]));
                const currentPrice = closes15[closes15.length - 1];
                const rsi15 = calculateRSI(closes15);
                const rsi1h = calculateRSI(closes1h);

                // 2. è·å–æŒä»“çŠ¶æ€
                const positions = await privateRequest('GET', '/fapi/v2/positionRisk', { symbol });
                const pos = positions.find(p => p.symbol === symbol);
                const currentAmt = parseFloat(pos.positionAmt);
                const entryPrice = parseFloat(pos.entryPrice);
                isHolding = currentAmt !== 0;

                // 3. è®¡ç®— ROI
                let roi = 0;
                if (isHolding) {
                    // (å½“å‰ä»· - å…¥åœºä»·) / å…¥åœºä»· * æ æ† * 100
                    roi = (currentPrice - entryPrice) / entryPrice * lev * 100;
                }

                // 4. æ›´æ–° UI
                updateUI(symbol, currentPrice, rsi15, rsi1h, roi, entryPrice);
                document.getElementById('balanceDisplay').innerText = '-- USDT'; // éœ€è¦å•ç‹¬æŸ¥ä½™é¢
                document.getElementById('entryPriceDisplay').innerText = isHolding ? entryPrice.toFixed(6) : '--';
                const roiEl = document.getElementById('roiDisplay');
                roiEl.innerText = isHolding ? roi.toFixed(2) + ' %' : '-- %';
                roiEl.className = `text-xl font-bold ${roi >= 0 ? 'text-emerald-400' : 'text-red-400'}`;

                // --- è‡ªåŠ¨åŒ–ç­–ç•¥é€»è¾‘ ---

                // A. å…¥åœºåˆ¤æ–­: RSI 97 åŒæ—¶è¾¾æˆ
                if (rsi15 >= buyLimit && rsi1h >= buyLimit && !isHolding) {
                    log(`ğŸš€ è§¦å‘å…¥åœºæ¡ä»¶! RSI 15m:${rsi15.toFixed(1)} 1h:${rsi1h.toFixed(1)}`, 'text-orange-400 font-bold');
                    let qty = Math.floor((initU * lev) / currentPrice);
                    const ok = await executeTrade(symbol, 'BUY', qty);
                    if(ok) {
                        isHolding = true;
                        hasAddedForCurrentDrop = false; // é‡ç½®åŠ ä»“é”
                    }
                }

                // B. æ­¢ç›ˆåˆ¤æ–­: ROI >= 30%
                if (isHolding && roi >= targetROI) {
                    log(`ğŸ’° è¾¾åˆ°ç›ˆåˆ©ç›®æ ‡ (${roi.toFixed(1)}%)ï¼Œæ­£åœ¨æ­¢ç›ˆç¦»åœº...`, 'text-emerald-400 font-bold');
                    const ok = await executeTrade(symbol, 'SELL', Math.abs(currentAmt));
                    if(ok) isHolding = false;
                }

                // C. è¡¥ä»“åˆ¤æ–­: ROI <= -20%
                if (isHolding && roi <= addThreshold && !hasAddedForCurrentDrop) {
                    log(`âš ï¸ äºæŸè§¦å‘è¡¥ä»“çº¿ (${roi.toFixed(1)}%)ï¼Œæ­£åœ¨è¿½åŠ  2U ä»“ä½...`, 'text-red-400 font-bold');
                    let addQty = Math.floor((addU * lev) / currentPrice);
                    const ok = await executeTrade(symbol, 'BUY', addQty);
                    if(ok) {
                        hasAddedForCurrentDrop = true; // æ­¤è½®äº¤æ˜“å·²è¡¥ä»“ï¼Œç­‰å¾…å›å‡æˆ–ç¦»åœº
                        document.getElementById('addCounter').innerText = parseInt(document.getElementById('addCounter').innerText) + 1;
                    }
                }

                // é‡ç½®åŠ ä»“é”ï¼šå¦‚æœä»·æ ¼å›å‡è‡³ -5% ä»¥ä¸Šï¼Œå¯ä»¥è€ƒè™‘å…è®¸å†æ¬¡åŠ ä»“ï¼ˆæˆ–è€…æŒ‰æ‚¨çš„è¦æ±‚åªåŠ ä¸€æ¬¡ï¼‰
                // è¿™é‡Œæˆ‘ä»¬ä¿æŒå®‰å…¨ï¼šæ¯è½®ä¹°å…¥å‘¨æœŸï¼ˆä»ç©ºä»“åˆ°å¼€ä»“ï¼‰åªåŠ ä»“ä¸€æ¬¡

                // ç‹¬ç«‹æŸ¥ä½™é¢
                const balanceData = await privateRequest('GET', '/fapi/v2/balance');
                const usdt = balanceData.find(b => b.asset === 'USDT');
                document.getElementById('balanceDisplay').innerText = parseFloat(usdt.balance).toFixed(2) + ' USDT';

            } catch (e) {
                log(`å¾ªç¯å‡ºé”™: ${e.message}`, 'text-slate-600');
            }
        }

        function updateUI(symbol, price, r15, r1h, roi, entry) {
            const grid = document.getElementById('tradingGrid');
            const roiStatus = roi >= 0 ? 'ç›ˆåˆ©ä¸­' : 'äºæŸä¸­';
            const roiClass = roi >= 0 ? 'text-emerald-400' : 'text-red-400';
            
            grid.innerHTML = `
                <div class="card p-8 rounded-3xl ${isHolding ? 'trade-active ring-2 ring-blue-500/50' : ''}">
                    <div class="flex justify-between items-center mb-10">
                        <div>
                            <h3 class="text-5xl font-black tracking-tighter">${symbol}</h3>
                            <p class="text-xs text-slate-500 font-bold mt-1 uppercase tracking-widest">Binance Perpetual Futures</p>
                        </div>
                        <div class="text-right">
                            <p class="text-4xl font-mono text-blue-400 font-bold leading-none">${price > 1 ? price.toFixed(4) : price.toFixed(6)}</p>
                            <span class="text-[10px] text-slate-600 font-bold">MARKET PRICE</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="card bg-slate-900/40 p-6 rounded-2xl border-none text-center">
                            <p class="text-[10px] text-slate-500 mb-2 uppercase font-bold tracking-widest">15m RSI (RMA)</p>
                            <p class="text-7xl font-black ${r15 >= 90 ? 'text-red-500 animate-pulse' : 'text-slate-300'}">${r15.toFixed(1)}</p>
                        </div>
                        <div class="card bg-slate-900/40 p-6 rounded-2xl border-none text-center">
                            <p class="text-[10px] text-slate-500 mb-2 uppercase font-bold tracking-widest">1h RSI (RMA)</p>
                            <p class="text-7xl font-black ${r1h >= 90 ? 'text-red-500 animate-pulse' : 'text-slate-300'}">${r1h.toFixed(1)}</p>
                        </div>
                    </div>

                    ${isHolding ? `
                    <div class="mt-8 pt-8 border-t border-slate-700/50 flex flex-col md:flex-row justify-between items-center">
                        <div class="flex items-center gap-4">
                            <div class="w-3 h-3 bg-emerald-500 rounded-full animate-pulse"></div>
                            <span class="text-sm font-bold text-slate-300 uppercase">æ­£åœ¨è¿è¡Œç­–ç•¥æŒä»“</span>
                        </div>
                        <div class="mt-4 md:mt-0 text-center md:text-right">
                            <p class="text-xs text-slate-500 font-bold uppercase">å½“å‰ç›ˆäºçŠ¶æ€</p>
                            <p class="text-2xl font-black ${roiClass}">${roiStatus} ${roi.toFixed(2)}%</p>
                        </div>
                    </div>
                    ` : `
                    <div class="mt-8 text-center py-4 bg-slate-900/20 rounded-xl">
                        <p class="text-xs text-slate-600 font-bold uppercase tracking-widest">æ­£åœ¨ç›‘æµ‹ RSI 97 å…¥åœºä¿¡å·...</p>
                    </div>
                    `}
                </div>
            `;
        }

        document.getElementById('runBtn').onclick = () => {
            if(document.getElementById('saveConfig').checked) {
                localStorage.setItem('rsi_api_key', document.getElementById('apiKey').value);
                localStorage.setItem('rsi_api_secret', document.getElementById('apiSecret').value);
            }
            isRunning = true;
            document.getElementById('runBtn').classList.add('hidden');
            document.getElementById('stopBtn').classList.remove('hidden');
            document.getElementById('statusDot').className = 'w-3 h-3 rounded-full bg-blue-500 mr-2 animate-ping';
            document.getElementById('statusText').innerText = 'æœºå™¨äººç­–ç•¥è¿è¡Œä¸­';
            log("ç›ˆäºç®¡ç†å¼•æ“å¯åŠ¨...", "text-blue-400 font-bold");
            updateLogic();
            scanTimer = setInterval(updateLogic, 10000); // 10ç§’æ£€æŸ¥ä¸€æ¬¡ç›ˆäºï¼Œæé«˜ååº”é€Ÿåº¦
        };

        document.getElementById('stopBtn').onclick = () => {
            isRunning = false;
            clearInterval(scanTimer);
            document.getElementById('runBtn').classList.remove('hidden');
            document.getElementById('stopBtn').classList.add('hidden');
            document.getElementById('statusDot').className = 'w-3 h-3 rounded-full bg-slate-500 mr-2';
            document.getElementById('statusText').innerText = 'å·²åœæœº';
            log("æœºå™¨äººå·²å®‰å…¨åœæ­¢è¿è¡Œã€‚");
        };
    </script>
</body>
</html>


