<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KANG Mining</title>
    
    <script src="https://cdn.staticfile.org/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                              radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                              radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            background-size: cover;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            width: 100%; max-width: 400px; border-radius: 24px; padding: 2rem;
            position: relative; z-index: 10;
        }
        .btn-gold {
            background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%);
            color: #3e2723; transition: all 0.3s ease; font-weight: 800; border: none;
        }
        .btn-gold:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(253, 185, 49, 0.3); }
        .btn-gold:active:not(:disabled) { transform: translateY(0); }
        .btn-gold:disabled { background: #334155; color: #94a3b8; cursor: not-allowed; box-shadow: none; }
        .pot-glow { text-shadow: 0 0 25px rgba(255, 215, 0, 0.4); }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); }
        .mini-btn {
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: #94a3b8;
            padding: 10px; border-radius: 12px; font-size: 0.75rem; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
        }
        .mini-btn:hover { background: rgba(255,255,255,0.1); color: #FFD700; border-color: #FFD700; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="absolute top-8 w-full text-center z-0">
        <h1 class="text-3xl font-extrabold tracking-tight text-white/90">KANG <span class="text-yellow-500">PROTOCOL</span></h1>
        <p class="text-[10px] text-gray-400 mt-1 tracking-[0.2em] uppercase">Fair Launch â€¢ Win or Share</p>
    </div>

    <div class="glass-card fade-in">
        
        <div class="text-center mb-8">
            <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Current Reward Pot</div>
            <div class="relative">
                <div id="potValue" class="text-5xl font-black text-white pot-glow font-mono">LOADING</div>
                <div class="text-xs font-bold text-yellow-500 mt-2">PENDING KANG TOKENS</div>
            </div>
        </div>

        <div id="connectView" class="text-center">
            <button onclick="connectWallet()" class="btn-gold w-full py-4 rounded-xl text-lg shadow-lg flex items-center justify-center gap-2">
                <i class="fas fa-wallet"></i> è¿æ¥é’±åŒ… (Connect)
            </button>
            <p class="text-xs text-gray-500 mt-4">Connect wallet to start mining</p>
        </div>

        <div id="miningView" class="hidden space-y-4">
            <div id="statusLog" class="bg-gray-800/50 rounded-lg p-3 text-xs text-center text-gray-300 font-mono border border-gray-700/50">
                å‡†å¤‡å°±ç»ª System Ready
            </div>

            <div class="grid gap-3">
                <button id="submitBtn" onclick="submitClaim()" class="btn-gold w-full py-4 rounded-xl text-lg shadow-lg relative overflow-hidden">
                    <div class="relative z-10 flex items-center justify-center gap-2">
                        <i class="fas fa-hammer"></i> ç«‹å³æŠ¢å¤º (Submit)
                    </div>
                </button>

                <div class="text-center py-1">
                    <span id="timerText" class="text-xs text-gray-500 font-mono">--- IDLE ---</span>
                </div>

                <button id="finalizeBtn" onclick="finalizePayout()" disabled class="w-full py-4 rounded-xl font-bold text-lg border-2 border-yellow-500/30 text-yellow-500 hover:bg-yellow-500/10 transition disabled:opacity-30 disabled:border-gray-700 disabled:text-gray-600">
                    <div class="flex items-center justify-center gap-2">
                        <i class="fas fa-download"></i> ç»“ç®—é¢†å¸ (Finalize)
                    </div>
                </button>
            </div>

            <div class="text-center pt-2">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-black/20 text-[10px] text-gray-400 font-mono">
                    <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                    <span id="userDisplay">0x00...0000</span>
                </div>
            </div>
        </div>

        <div class="action-grid">
            <div class="mini-btn" onclick="copyCA()">
                <i class="fas fa-copy"></i>
                <span>å¤åˆ¶åˆçº¦åœ°å€</span>
            </div>
            <div class="mini-btn" onclick="openBscScan()">
                <i class="fas fa-external-link-alt"></i>
                <span>æŸ¥çœ‹ BscScan</span>
            </div>
        </div>

    </div>

    <script>
        const CA = "0x65a762e8B7639596dbFBCcd9A541d44B0CF67762";
        const ABI = [
            "function submitClaim() public",
            "function finalizePayout() public",
            "function checkCurrentPot() public view returns (uint256)",
            "function currentCycleId() public view returns (uint256)",
            "function lastClaimedCycleId(address) public view returns (uint256)",
            "function currentCycle() public view returns (uint256, uint256, address[], bool)"
        ];

        let provider, signer, contract, readOnlyContract;
        
        const el = {
            pot: document.getElementById('potValue'),
            connectView: document.getElementById('connectView'),
            miningView: document.getElementById('miningView'),
            status: document.getElementById('statusLog'),
            timer: document.getElementById('timerText'),
            submit: document.getElementById('submitBtn'),
            finalize: document.getElementById('finalizeBtn'),
            user: document.getElementById('userDisplay')
        };

        // 1. åˆå§‹åŒ– (ç”¨ä½ éªŒè¯è¿‡çš„æº)
        async function init() {
            if(typeof ethers === 'undefined') {
                el.pot.innerText = "Error";
                alert("ä¸¥é‡é”™è¯¯ï¼šæ ¸å¿ƒåº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼");
                return;
            }

            try {
                const rpc = new ethers.providers.JsonRpcProvider("https://bsc-dataseed.binance.org/");
                readOnlyContract = new ethers.Contract(CA, ABI, rpc);
                loopPot();
            } catch(e) { console.error(e); }

            if(window.ethereum) {
                const acc = await window.ethereum.request({method:'eth_accounts'});
                if(acc.length > 0) connectWallet();
            }
        }

        async function loopPot() {
            if(readOnlyContract) {
                try {
                    const v = await readOnlyContract.checkCurrentPot();
                    el.pot.innerText = parseFloat(ethers.utils.formatUnits(v, 18)).toFixed(4);
                } catch(e) {}
            }
            setTimeout(loopPot, 3000);
        }

        // 2. è¿æ¥é’±åŒ… (å¢å¼ºå…¼å®¹æ€§)
        async function connectWallet() {
            if(!window.ethereum) return alert("è¯·åœ¨é’±åŒ…æµè§ˆå™¨ä¸­æ‰“å¼€æ­¤ç½‘é¡µï¼");
            
            try {
                // è¯·æ±‚è¿æ¥
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                // è‡ªåŠ¨åˆ‡é“¾åˆ° BSC
                await switchToBSC();

                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(CA, ABI, signer);
                
                const addr = await signer.getAddress();
                
                // åˆ‡æ¢ç•Œé¢
                el.connectView.classList.add('hidden');
                el.miningView.classList.remove('hidden');
                el.user.innerText = addr.slice(0,6) + "..." + addr.slice(-4);

                // ç«‹å³æ£€æŸ¥çŠ¶æ€ (æ ¸å¿ƒä¿®å¤ï¼šé˜²æ­¢ Already Submitted æŠ¥é”™)
                checkUserStatus(addr);

            } catch(e) { alert("è¿æ¥å¤±è´¥: " + e.message); }
        }

        // 3. æ™ºèƒ½çŠ¶æ€æ£€æµ‹ (é˜²æ­¢çº¢å­—æŠ¥é”™)
        async function checkUserStatus(addr) {
            try {
                const curId = await contract.currentCycleId();
                const lastId = await contract.lastClaimedCycleId(addr);
                const cycleData = await contract.currentCycle(); 
                const isFinalized = cycleData[3];

                // å¦‚æœæœ¬è½®å·²å‚ä¸ä¸”æœªç»“ç®—
                if(curId.eq(lastId) && !isFinalized) {
                    el.submit.disabled = true;
                    el.submit.innerHTML = "<i class='fas fa-check'></i> æœ¬è½®å·²æŠ¢ (Wait)";
                    el.finalize.disabled = false;
                    el.timer.innerText = ">>> ç­‰å¾…ç»“ç®— (Action Required) <<<";
                    el.timer.style.color = "#FFD700";
                    setStatus("æ£€æµ‹åˆ°æ‚¨å·²å‚ä¸ï¼Œè¯·ç‚¹å‡»ç»“ç®—ï¼", "warn");
                } else {
                    el.submit.disabled = false;
                    el.submit.innerHTML = "<i class='fas fa-hammer'></i> ç«‹å³æŠ¢å¤º (Submit)";
                    el.finalize.disabled = true;
                    el.timer.innerText = "--- ç©ºé—² Idle ---";
                    el.timer.style.color = "#94a3b8";
                }
            } catch(e) { console.error(e); }
        }

        // 4. æŠ¢å¤ºé€»è¾‘
        async function submitClaim() {
            try {
                setStatus("æ­£åœ¨è¯·æ±‚é’±åŒ…ç­¾å...", "loading");
                const tx = await contract.submitClaim();
                setStatus("äº¤æ˜“ä¸Šé“¾ä¸­...è¯·ç¨å€™", "loading");
                await tx.wait();
                
                setStatus("é”å®šæˆåŠŸï¼ç­‰å¾… 4 ç§’å®‰å…¨æœŸ...", "success");
                el.finalize.disabled = false;
                el.submit.disabled = true; // ç«‹å³ç¦ç”¨é˜²æ­¢é‡å¤ç‚¹
                
                let t = 4;
                const iv = setInterval(() => {
                    t--;
                    if(t > 0) el.timer.innerText = `ç­‰å¾…åŒºå—ç¡®è®¤... ${t}s`;
                    else {
                        clearInterval(iv);
                        el.timer.innerText = ">>> çª—å£æœŸç»“æŸï¼Œå¯ç»“ç®— <<<";
                        el.timer.style.color = "#FFD700";
                        setStatus("è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç»“ç®—é¢†å¸ï¼", "warn");
                    }
                }, 1000);
            } catch(e) { handleErr(e); }
        }

        // 5. ç»“ç®—é€»è¾‘
        async function finalizePayout() {
            try {
                setStatus("æ­£åœ¨å‘èµ·ç»“ç®—...", "loading");
                const tx = await contract.finalizePayout();
                await tx.wait();
                
                setStatus("ğŸ‰ æˆåŠŸï¼æ”¶ç›Šå·²åˆ°è´¦", "success");
                setTimeout(() => {
                    // é‡ç½®çŠ¶æ€
                    checkUserStatus(el.user.innerText);
                    setStatus("å‡†å¤‡å°±ç»ª System Ready", "normal");
                }, 3000);
            } catch(e) { handleErr(e); }
        }

        // è¾…åŠ©å‡½æ•°
        async function switchToBSC() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x38' }],
                });
            } catch (err) {
                if (err.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0x38',
                            chainName: 'Binance Smart Chain',
                            nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
                            rpcUrls: ['https://bsc-dataseed.binance.org/'],
                            blockExplorerUrls: ['https://bscscan.com/'],
                        }],
                    });
                }
            }
        }

        function setStatus(msg, type) {
            el.status.innerText = msg;
            el.status.className = "rounded-lg p-3 text-xs text-center font-mono border transition-all ";
            if(type === 'loading') el.status.className += "bg-blue-900/30 text-blue-300 border-blue-800 animate-pulse";
            else if(type === 'success') el.status.className += "bg-green-900/30 text-green-300 border-green-800";
            else if(type === 'warn') el.status.className += "bg-yellow-900/30 text-yellow-300 border-yellow-800";
            else el.status.className += "bg-gray-800/50 text-gray-300 border-gray-700/50";
        }

        function handleErr(e) {
            let m = "äº¤æ˜“å¤±è´¥";
            if(e.reason) m = e.reason;
            if(e.message && e.message.includes("user rejected")) m = "ç”¨æˆ·å–æ¶ˆ";
            if(m.includes("Window")) m = "å¤ªå¿«äº†ï¼è¯·ç­‰å¾…å€’è®¡æ—¶";
            if(m.includes("Already submitted")) m = "æœ¬è½®æ‚¨å·²å‚ä¸ï¼è¯·ç›´æ¥ç»“ç®—";
            
            setStatus("âŒ " + m, "error");
            if(m.includes("å·²å‚ä¸")) checkUserStatus(el.user.innerText);
        }

        function copyCA() {
            navigator.clipboard.writeText(CA);
            alert("âœ… åœ°å€å·²å¤åˆ¶");
        }
        function openBscScan() {
            window.open(`https://bscscan.com/address/${CA}`, '_blank');
        }

        window.onload = init;
    </script>
</body>
</html>