<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KANG Mining & Dino</title>
    
    <script src="https://cdn.staticfile.org/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=VT323&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                              radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                              radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            background-size: cover;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* æ”¹ä¸ºä»ä¸Šåˆ°ä¸‹æ’åˆ— */
            padding: 2rem 1rem;
            gap: 1.5rem;
        }
        
        /* æŒ–çŸ¿ä¸»å¡ç‰‡ */
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            width: 100%; max-width: 400px; border-radius: 24px; padding: 2rem;
            position: relative; z-index: 10;
        }

        /* æ¸¸æˆå¡ç‰‡ */
        .game-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            width: 100%; max-width: 400px;
            padding: 1rem;
            text-align: center;
            overflow: hidden;
        }

        .btn-gold {
            background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%);
            color: #3e2723; transition: all 0.3s ease; font-weight: 800; border: none;
            cursor: pointer; opacity: 1 !important;
        }
        .btn-gold:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(253, 185, 49, 0.3); }
        
        .btn-green {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: #064e3b; transition: all 0.3s ease; font-weight: 800; border: none;
            cursor: pointer; opacity: 1 !important;
        }
        .btn-green:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(74, 222, 128, 0.4); }

        .pot-glow { text-shadow: 0 0 25px rgba(255, 215, 0, 0.4); }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); }
        .mini-btn {
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: #94a3b8;
            padding: 10px; border-radius: 12px; font-size: 0.75rem; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
        }
        .mini-btn:hover { background: rgba(255,255,255,0.1); color: #FFD700; border-color: #FFD700; }
        
        /* æ¸¸æˆç”»å¸ƒ */
        canvas { 
            background: rgba(0,0,0,0.2); 
            border-radius: 8px; 
            width: 100%; 
            image-rendering: pixelated;
            touch-action: none; /* é˜²æ­¢ç‚¹å‡»æ¸¸æˆæ—¶æ”¾å¤§ */
        }
        
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="text-center z-0 mb-2">
        <h1 class="text-3xl font-extrabold tracking-tight text-white/90">KANG <span class="text-yellow-500">PROTOCOL</span></h1>
        <p class="text-[10px] text-gray-400 mt-1 tracking-[0.2em] uppercase">Fair Launch â€¢ Win or Share</p>
    </div>

    <div class="glass-card fade-in">
        
        <div class="text-center mb-6">
            <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Current Reward Pot</div>
            <div class="relative">
                <div id="potValue" class="text-3xl md:text-5xl font-black text-white pot-glow font-mono break-all">LOADING</div>
                <div class="text-xs font-bold text-yellow-500 mt-2">PENDING KANG TOKENS</div>
            </div>
        </div>

        <div id="connectView" class="text-center">
            <button onclick="connectWallet()" class="btn-gold w-full py-4 rounded-xl text-lg shadow-lg flex items-center justify-center gap-2">
                <i class="fas fa-wallet"></i> è¿æ¥é’±åŒ… (Connect)
            </button>
            <p class="text-xs text-gray-500 mt-4">Connect wallet to start mining</p>
        </div>

        <div id="miningView" class="hidden space-y-4">
            <div id="statusLog" class="bg-gray-800/50 rounded-lg p-3 text-xs text-center text-gray-300 font-mono border border-gray-700/50">
                å‡†å¤‡å°±ç»ª System Ready
            </div>

            <div class="bg-yellow-900/30 border border-yellow-700/50 rounded-lg p-3 text-left">
                <div class="text-[10px] text-yellow-500 font-bold mb-1 flex items-center gap-1">
                    <i class="fas fa-exclamation-triangle"></i> RULES:
                </div>
                <ul class="text-[10px] text-gray-300 list-disc list-inside space-y-1">
                    <li>æƒ³åˆ†é’±å¿…é¡»å…ˆç‚¹ <span class="text-yellow-400 font-bold">ç«‹å³æŠ¢å¤º</span>ã€‚</li>
                    <li>ç‚¹å‡» <span class="text-green-400 font-bold">ç»“ç®—</span> è§¦å‘åˆ†çº¢ï¼Œè· 5% èµé‡‘ã€‚</li>
                </ul>
            </div>

            <div class="grid gap-3">
                <button id="submitBtn" onclick="submitClaim()" class="btn-gold w-full py-4 rounded-xl text-lg shadow-lg relative overflow-hidden">
                    <div class="relative z-10 flex items-center justify-center gap-2">
                        <i class="fas fa-hammer"></i> ç«‹å³æŠ¢å¤º (Submit)
                    </div>
                </button>

                <button id="finalizeBtn" onclick="finalizePayout()" class="btn-green w-full py-4 rounded-xl font-bold text-lg shadow-lg">
                    <div class="flex items-center justify-center gap-2">
                        <i class="fas fa-download"></i> ç»“ç®—é¢†å¸ (Finalize)
                    </div>
                </button>
            </div>

            <div class="text-center pt-2">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-black/20 text-[10px] text-gray-400 font-mono">
                    <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                    <span id="userDisplay">0x00...0000</span>
                </div>
            </div>
        </div>

        <div class="action-grid">
            <div class="mini-btn" onclick="copyCA()">
                <i class="fas fa-copy"></i>
                <span>å¤åˆ¶åˆçº¦</span>
            </div>
            <div class="mini-btn" onclick="openBscScan()">
                <i class="fas fa-external-link-alt"></i>
                <span>æŸ¥çœ‹ BscScan</span>
            </div>
        </div>
    </div>

    <div class="game-card fade-in" style="animation-delay: 0.2s;">
        <div class="flex justify-between items-center mb-2 px-1">
            <div class="text-[10px] text-gray-400 font-mono">WAITING? PLAY DINO!</div>
            <div class="text-[10px] text-yellow-500 font-mono font-bold">SCORE: <span id="gameScore">0</span></div>
        </div>
        <canvas id="dinoCanvas" width="600" height="150"></canvas>
        <div class="text-[9px] text-gray-600 mt-2">TAP TO JUMP / ç‚¹å‡»å±å¹•è·³è·ƒ</div>
    </div>

    <script>
        // --- DAPP é€»è¾‘ ---
        const CA = "0x65a762e8B7639596dbFBCcd9A541d44B0CF67762";
        const ABI = [
            "function submitClaim() public",
            "function finalizePayout() public",
            "function checkCurrentPot() public view returns (uint256)",
            "function currentCycleId() public view returns (uint256)",
            "function lastClaimedCycleId(address) public view returns (uint256)",
            "function currentCycle() public view returns (uint256, uint256, address[], bool)"
        ];

        let provider, signer, contract, readOnlyContract;
        
        const el = {
            pot: document.getElementById('potValue'),
            connectView: document.getElementById('connectView'),
            miningView: document.getElementById('miningView'),
            status: document.getElementById('statusLog'),
            submit: document.getElementById('submitBtn'),
            finalize: document.getElementById('finalizeBtn'),
            user: document.getElementById('userDisplay')
        };

        // --- åˆå§‹åŒ– DAPP ---
        async function init() {
            if(typeof ethers === 'undefined') { el.pot.innerText = "Error"; return; }
            try {
                const rpc = new ethers.providers.JsonRpcProvider("https://bsc-dataseed.binance.org/");
                readOnlyContract = new ethers.Contract(CA, ABI, rpc);
                loopPot();
            } catch(e) {}
            if(window.ethereum) {
                const acc = await window.ethereum.request({method:'eth_accounts'});
                if(acc.length > 0) connectWallet();
            }
            initGame(); // å¯åŠ¨æ¸¸æˆ
        }

        async function loopPot() {
            if(readOnlyContract) {
                try {
                    const v = await readOnlyContract.checkCurrentPot();
                    el.pot.innerText = parseFloat(ethers.utils.formatUnits(v, 18)).toFixed(4);
                } catch(e) {}
            }
            setTimeout(loopPot, 3000);
        }

        async function connectWallet() {
            if(!window.ethereum) return alert("è¯·åœ¨é’±åŒ…æµè§ˆå™¨ä¸­æ‰“å¼€ï¼");
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                await switchToBSC();
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(CA, ABI, signer);
                const addr = await signer.getAddress();
                el.connectView.classList.add('hidden');
                el.miningView.classList.remove('hidden');
                el.user.innerText = addr.slice(0,6) + "..." + addr.slice(-4);
            } catch(e) { alert("è¿æ¥å¤±è´¥: " + e.message); }
        }

        async function submitClaim() {
            try {
                setStatus("æ­£åœ¨è¯·æ±‚ç­¾å...", "loading");
                const tx = await contract.submitClaim();
                setStatus("ä¸Šé“¾ä¸­...ç©æŠŠæ¸¸æˆç­‰å¾…å§ï¼", "loading"); // æç¤ºç©æ¸¸æˆ
                await tx.wait();
                setStatus("âœ… ç™»è®°æˆåŠŸï¼ç­‰å¾…ç»“ç®—...", "success");
            } catch(e) { handleErr(e); }
        }

        async function finalizePayout() {
            try {
                setStatus("æ­£åœ¨ç»“ç®—...", "loading");
                const tx = await contract.finalizePayout();
                await tx.wait();
                setStatus("ğŸ‰ ç»“ç®—æˆåŠŸï¼èµé‡‘åˆ°è´¦", "success");
                setTimeout(() => { location.reload(); }, 2000);
            } catch(e) { handleErr(e); }
        }

        async function switchToBSC() {
            try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x38' }] }); } catch (e) {
                if (e.code === 4902) await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: '0x38', chainName: 'Binance Smart Chain', nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 }, rpcUrls: ['https://bsc-dataseed.binance.org/'], blockExplorerUrls: ['https://bscscan.com/'] }] });
            }
        }

        function setStatus(msg, type) {
            el.status.innerText = msg;
            el.status.className = "rounded-lg p-3 text-xs text-center font-mono border transition-all ";
            if(type === 'loading') el.status.className += "bg-blue-900/30 text-blue-300 border-blue-800 animate-pulse";
            else if(type === 'success') el.status.className += "bg-green-900/30 text-green-300 border-green-800";
            else if(type === 'warn') el.status.className += "bg-yellow-900/30 text-yellow-300 border-yellow-800";
            else el.status.className += "bg-gray-800/50 text-gray-300 border-gray-700/50";
        }

        function handleErr(e) {
            let m = "äº¤æ˜“å¤±è´¥";
            if(e.reason) m = e.reason;
            if(e.message && e.message.includes("user rejected")) m = "ç”¨æˆ·å–æ¶ˆ";
            if(m.includes("Already submitted")) m = "æœ¬è½®å·²ç™»è®°ï¼è¯·ç›´æ¥ç‚¹ç»“ç®—";
            setStatus("âŒ " + m, "error");
        }

        function copyCA() { navigator.clipboard.writeText(CA); alert("âœ… åœ°å€å·²å¤åˆ¶"); }
        function openBscScan() { window.open(`https://bscscan.com/address/${CA}`, '_blank'); }

        // --- ğŸ® æç®€æé¾™æ¸¸æˆå¼•æ“ ---
        function initGame() {
            const canvas = document.getElementById('dinoCanvas');
            const ctx = canvas.getContext('2d');
            const scoreEl = document.getElementById('gameScore');
            
            let gameRunning = false;
            let score = 0;
            let dino = { x: 50, y: 100, w: 20, h: 20, dy: 0, jumpPower: -8, ground: 100 };
            let cactus = { x: 600, y: 100, w: 10, h: 20, speed: 4 };
            let gravity = 0.4;

            function reset() {
                dino.y = dino.ground; dino.dy = 0;
                cactus.x = 600; score = 0; scoreEl.innerText = 0;
                gameRunning = true;
                requestAnimationFrame(update);
            }

            function jump() {
                if(!gameRunning) reset();
                else if(dino.y === dino.ground) dino.dy = dino.jumpPower;
            }

            // è¾“å…¥ç›‘å¬
            canvas.addEventListener('mousedown', jump);
            canvas.addEventListener('touchstart', (e) => { e.preventDefault(); jump(); });
            document.addEventListener('keydown', (e) => { if(e.code === 'Space') { e.preventDefault(); jump(); } });

            function update() {
                if(!gameRunning) return;

                // æ¸…å±
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // åœ°é¢çº¿
                ctx.beginPath(); ctx.moveTo(0, 120); ctx.lineTo(600, 120);
                ctx.strokeStyle = '#555'; ctx.stroke();

                // æé¾™ (é»„è‰²å—)
                if(dino.y < dino.ground) dino.dy += gravity;
                dino.y += dino.dy;
                if(dino.y > dino.ground) { dino.y = dino.ground; dino.dy = 0; }
                
                ctx.fillStyle = '#FFD700';
                ctx.fillRect(dino.x, dino.y, dino.w, dino.h);

                // ä»™äººæŒ (ç»¿è‰²å—)
                cactus.x -= cactus.speed;
                if(cactus.x < -20) {
                    cactus.x = 600 + Math.random() * 200;
                    score++; scoreEl.innerText = score;
                    cactus.speed += 0.1; // è¶Šè·‘è¶Šå¿«
                }
                ctx.fillStyle = '#4ade80';
                ctx.fillRect(cactus.x, cactus.y, cactus.w, cactus.h);

                // ç¢°æ’æ£€æµ‹
                if(dino.x < cactus.x + cactus.w && dino.x + dino.w > cactus.x && dino.y < cactus.y + cactus.h && dino.y + dino.h > cactus.y) {
                    gameRunning = false;
                    ctx.fillStyle = 'white'; ctx.font = '20px monospace';
                    ctx.fillText("GAME OVER - TAP TO RESTART", 150, 70);
                } else {
                    requestAnimationFrame(update);
                }
            }

            // åˆå§‹ç”»é¢
            ctx.fillStyle = '#666'; ctx.font = '20px monospace';
            ctx.fillText("TAP TO START", 230, 70);
        }

        window.onload = init;
    </script>
</body>
</html>