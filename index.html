<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KANG Mining & Dino</title>
    
    <script src="https://cdn.staticfile.org/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=VT323&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                              radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                              radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            background-size: cover;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 2rem 1rem;
            gap: 1.5rem;
        }
        
        .header-box { position: relative; z-index: 20; text-align: center; margin-bottom: 0.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .glass-card {
            background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            width: 100%; max-width: 400px; border-radius: 24px; padding: 2rem; position: relative; z-index: 10;
        }
        .game-card {
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px; width: 100%; max-width: 400px; padding: 1rem; text-align: center; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* æŒ‰é’®çŠ¶æ€ */
        .btn-gold {
            background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%); color: #3e2723;
            transition: all 0.2s; font-weight: 800; border: none; cursor: pointer;
        }
        .btn-gold:disabled { background: #475569; color: #94a3b8; cursor: not-allowed; opacity: 0.6; }
        
        .btn-green {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); color: #064e3b;
            transition: all 0.2s; font-weight: 800; border: none; cursor: pointer;
        }
        .btn-green:disabled { background: #1e293b; color: #475569; border: 2px solid #334155; cursor: not-allowed; opacity: 1; }
        
        /* ğŸ”´ å¼ºåˆ¶æ¸…åœºæŒ‰é’® (çº¢è‰²) - åªç»“ç®—ï¼Œä¸æŠ¢å¤º */
        .btn-clear {
            background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); color: #fff;
            transition: all 0.2s; font-weight: 800; border: none; cursor: pointer;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
        }
        .btn-clear:hover { transform: scale(1.02); }

        .pot-glow { text-shadow: 0 0 25px rgba(255, 215, 0, 0.4); }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); }
        .mini-btn {
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: #94a3b8;
            padding: 10px; border-radius: 12px; font-size: 0.75rem; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
        }
        
        canvas { background: rgba(255, 255, 255, 0.1); border-radius: 8px; width: 100%; touch-action: none; border: 1px solid rgba(255,255,255,0.1); }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.3; } }
    </style>
</head>
<body>

    <div class="header-box">
        <h1 class="text-3xl font-extrabold tracking-tight text-white">KANG <span class="text-yellow-500">PROTOCOL</span></h1>
        <p class="text-[10px] text-gray-400 mt-1 tracking-[0.2em] uppercase">Fair Launch â€¢ Win or Share</p>
    </div>

    <div class="glass-card fade-in">
        <div class="text-center mb-6">
            <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Current Reward Pot</div>
            <div class="relative">
                <div id="potValue" class="text-3xl md:text-5xl font-black text-white pot-glow font-mono break-all leading-tight">LOADING...</div>
                <div class="text-xs font-bold text-yellow-500 mt-2">PENDING KANG TOKENS</div>
                <div id="nodeStatus" class="text-[9px] text-gray-500 mt-1">Connecting...</div>
            </div>
        </div>

        <div id="connectView" class="text-center">
            <button onclick="connectWallet()" class="btn-gold w-full py-4 rounded-xl text-lg shadow-lg flex items-center justify-center gap-2">
                <i class="fas fa-wallet"></i> è¿æ¥é’±åŒ… (Connect)
            </button>
        </div>

        <div id="miningView" class="hidden space-y-4">
            <div id="statusLog" class="bg-gray-800/50 rounded-lg p-3 text-xs text-center text-gray-300 font-mono border border-gray-700/50">
                å‡†å¤‡å°±ç»ª System Ready
            </div>

            <div id="infoBar" class="bg-blue-900/30 border border-blue-700/50 rounded-lg p-3 text-left hidden">
                <div class="text-[11px] text-blue-200 flex items-center gap-2">
                    <i class="fas fa-info-circle"></i> <span id="infoText">æ£€æµ‹ä¸­...</span>
                </div>
            </div>

            <div class="grid gap-3">
                <button id="submitBtn" onclick="submitClaim()" class="btn-gold w-full py-4 rounded-xl text-lg shadow-lg relative overflow-hidden">
                    <div class="relative z-10 flex items-center justify-center gap-2">
                        <i class="fas fa-hammer"></i> ç«‹å³æŠ¢å¤º (Submit)
                    </div>
                </button>

                <button id="finalizeBtn" onclick="finalizePayout()" disabled class="btn-green w-full py-4 rounded-xl font-bold text-lg shadow-lg">
                    <div class="flex items-center justify-center gap-2">
                        <i class="fas fa-download"></i> ç»“ç®—é¢†å¸ (Finalize)
                    </div>
                </button>
            </div>

            <div class="text-center pt-2">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-black/20 text-[10px] text-gray-400 font-mono">
                    <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                    <span id="userDisplay">0x00...0000</span>
                </div>
            </div>
        </div>

        <div class="action-grid">
            <div class="mini-btn" onclick="copyCA()">
                <i class="fas fa-copy"></i>
                <span>å¤åˆ¶åˆçº¦</span>
            </div>
            <div class="mini-btn" onclick="openBscScan()">
                <i class="fas fa-external-link-alt"></i>
                <span>æŸ¥çœ‹ BscScan</span>
            </div>
        </div>
    </div>

    <div class="game-card fade-in" style="animation-delay: 0.2s;">
        <div class="flex justify-between items-center mb-2 px-1">
            <div class="text-[10px] text-gray-300 font-mono font-bold"><i class="fas fa-gamepad"></i> å¨±ä¹æ—¶é—´</div>
            <div class="text-[10px] text-yellow-400 font-mono font-bold">SCORE: <span id="gameScore">0</span></div>
        </div>
        <canvas id="dinoCanvas" width="600" height="150"></canvas>
        <div class="text-[10px] text-yellow-200 mt-2 font-mono blink" id="gameTip">TAP TO START</div>
    </div>

    <script>
        const CA = "0x65a762e8B7639596dbFBCcd9A541d44B0CF67762";
        const ABI = [
            "function submitClaim() public",
            "function finalizePayout() public",
            "function checkCurrentPot() public view returns (uint256)",
            "function currentCycle() public view returns (uint256, uint256, address[], bool)"
        ];
        const RPC_LIST = ["https://bsc-dataseed.binance.org/", "https://bsc-dataseed1.defibit.io/", "https://bsc-dataseed1.ninicoin.io/"];

        let provider, signer, contract, readOnlyContract;
        
        const el = {
            pot: document.getElementById('potValue'),
            nodeStatus: document.getElementById('nodeStatus'),
            connectView: document.getElementById('connectView'),
            miningView: document.getElementById('miningView'),
            status: document.getElementById('statusLog'),
            user: document.getElementById('userDisplay'),
            submit: document.getElementById('submitBtn'),
            finalize: document.getElementById('finalizeBtn'),
            infoBar: document.getElementById('infoBar'),
            infoText: document.getElementById('infoText')
        };

        async function init() {
            if(typeof ethers === 'undefined') { el.pot.innerText = "Lib Error"; return; }
            let connected = false;
            for (let rpc of RPC_LIST) {
                try {
                    const tempProvider = new ethers.providers.JsonRpcProvider(rpc);
                    readOnlyContract = new ethers.Contract(CA, ABI, tempProvider);
                    await readOnlyContract.checkCurrentPot();
                    el.nodeStatus.innerText = "ğŸŸ¢ Node Synced";
                    connected = true;
                    loopPot(); checkGlobalState(); setInterval(checkGlobalState, 3000);
                    break;
                } catch(e) { }
            }
            if(!connected) { el.pot.innerText = "Net Error"; }
            if(window.ethereum) {
                const acc = await window.ethereum.request({method:'eth_accounts'});
                if(acc.length > 0) connectWallet();
            }
            initGame();
        }

        async function loopPot() {
            if(readOnlyContract) {
                try {
                    const v = await readOnlyContract.checkCurrentPot();
                    el.pot.innerText = parseFloat(ethers.utils.formatUnits(v, 18)).toFixed(4);
                } catch(e) {}
            }
            setTimeout(loopPot, 3000);
        }

        // ğŸ”´ æ ¸å¿ƒï¼šçŠ¶æ€æ£€æµ‹ (å†³å®šæŒ‰é’®åŠŸèƒ½)
        async function checkGlobalState() {
            if(!readOnlyContract) return;
            try {
                const cycleData = await readOnlyContract.currentCycle();
                const startTime = cycleData[1];
                const isFinalized = cycleData[3];

                // å¦‚æœæœ‰äººå ä½ä¸”æœªç»“ç®— (ä¸ç®¡æ˜¯è°)
                if(startTime.gt(0) && !isFinalized) {
                    
                    // 1. ç¦ç”¨æŠ¢å¤º (å› ä¸ºè¿˜æ²¡ç»“ç®—ï¼Œä¸èƒ½è¿›æ–°ä¸€è½®)
                    el.submit.disabled = true;
                    el.submit.innerHTML = "<i class='fas fa-lock'></i> æœ¬è½®è¢«å ç”¨ (Blocked)";
                    
                    // 2. å¯ç”¨æ¸…åœºæ¨¡å¼
                    el.finalize.disabled = false;
                    el.finalize.className = "btn-clear w-full py-4 rounded-xl font-bold text-lg shadow-lg"; // ğŸ”´ çº¢è‰²
                    el.finalize.innerHTML = "<div class='flex items-center justify-center gap-2'><i class='fas fa-trash-alt'></i> å¼ºåˆ¶ç»“ç®— (åªæ¸…åœºï¼Œä¸æŠ¢)</div>";
                    
                    el.infoBar.classList.remove('hidden');
                    el.infoText.innerText = "âš ï¸ åˆ«äººå¡å•äº†ï¼Ÿç‚¹å‡»çº¢è‰²æŒ‰é’®å¼ºåˆ¶æ¸…åœºï¼(æ¸…åœºåéœ€ç­‰å¾…å¥–æ± å¢é•¿å†æŠ¢)";
                    
                } else {
                    // æ­£å¸¸æ¨¡å¼
                    el.submit.disabled = false;
                    el.submit.innerHTML = "<div class='relative z-10 flex items-center justify-center gap-2'><i class='fas fa-hammer'></i> ç«‹å³æŠ¢å¤º (Submit)</div>";
                    
                    el.finalize.disabled = true;
                    el.finalize.className = "btn-green w-full py-4 rounded-xl font-bold text-lg shadow-lg opacity-50"; // ç°è‰²
                    el.finalize.innerHTML = "ç­‰å¾…æŠ¢å¤º...";
                    
                    el.infoBar.classList.add('hidden');
                }
            } catch(e) {}
        }

        async function connectWallet() {
            if(!window.ethereum) return alert("è¯·åœ¨é’±åŒ…æµè§ˆå™¨ä¸­æ‰“å¼€ï¼");
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                await switchToBSC();
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(CA, ABI, signer);
                readOnlyContract = contract;
                const addr = await signer.getAddress();
                el.connectView.classList.add('hidden');
                el.miningView.classList.remove('hidden');
                el.user.innerText = addr.slice(0,6) + "..." + addr.slice(-4);
                checkGlobalState();
            } catch(e) { alert("è¿æ¥å¤±è´¥"); }
        }

        async function submitClaim() {
            try {
                setStatus("è¯·æ±‚ç­¾å...", "loading");
                const tx = await contract.submitClaim();
                setStatus("ä¸Šé“¾ä¸­...ç­‰å¾…ç¡®è®¤", "loading"); 
                await tx.wait();
                setStatus("âœ… æŠ¢å¤ºæˆåŠŸï¼ç°åœ¨ä½ æ˜¯æœ¬è½®ä¸»å®°", "success");
                checkGlobalState();
            } catch(e) { handleErr(e); }
        }

        // ğŸ”´ æ ¸å¿ƒï¼šä»…æ¸…åœºï¼Œä¸è¿å‡»
        async function finalizePayout() {
            try {
                setStatus("æ­£åœ¨æ¸…ç†å¡å•...", "loading");
                const tx = await contract.finalizePayout();
                await tx.wait();
                
                setStatus("ğŸ§¹ æ¸…åœºæˆåŠŸï¼ç°åœ¨å¥–æ± å·²é‡ç½®ã€‚", "success");
                
                // ä»…åˆ·æ–°é¡µé¢ï¼Œä¸è‡ªåŠ¨æŠ¢
                setTimeout(() => { location.reload(); }, 2000);
            } catch(e) { handleErr(e); }
        }

        async function switchToBSC() {
            try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x38' }] }); } catch (e) {
                if (e.code === 4902) await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: '0x38', chainName: 'Binance Smart Chain', nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 }, rpcUrls: ['https://bsc-dataseed.binance.org/'], blockExplorerUrls: ['https://bscscan.com/'] }] });
            }
        }

        function setStatus(msg, type) {
            const s = document.getElementById('statusLog');
            s.innerText = msg;
            s.className = "rounded-lg p-3 text-xs text-center font-mono border transition-all ";
            if(type === 'loading') s.className += "bg-blue-900/30 text-blue-300 border-blue-800 animate-pulse";
            else if(type === 'success') s.className += "bg-green-900/30 text-green-300 border-green-800";
            else s.className += "bg-yellow-900/30 text-yellow-300 border-yellow-800";
        }

        function handleErr(e) {
            let m = "äº¤æ˜“å¤±è´¥";
            if(e.reason) m = e.reason;
            if(e.message && e.message.includes("user rejected")) m = "ç”¨æˆ·å–æ¶ˆ";
            if(m.includes("Already submitted")) { m = "æœ¬è½®å·²è¢«å ç”¨ï¼è¯·ç›´æ¥ç‚¹ç»“ç®—"; checkGlobalState(); }
            setStatus("âŒ " + m, "error");
        }

        function copyCA() { navigator.clipboard.writeText(CA); alert("âœ… åœ°å€å·²å¤åˆ¶"); }
        function openBscScan() { window.open(`https://bscscan.com/address/${CA}`, '_blank'); }

        // --- ğŸ® æé¾™æ¸¸æˆ ---
        function initGame() {
            const canvas = document.getElementById('dinoCanvas');
            const ctx = canvas.getContext('2d');
            const scoreEl = document.getElementById('gameScore');
            let gameRunning = false, score = 0;
            let dino = { x: 50, y: 110, dy: 0, jumpPower: -8, ground: 110 };
            let cactus = { x: 600, y: 110, speed: 4 };
            let gravity = 0.4;
            function reset() { dino.y = dino.ground; dino.dy = 0; cactus.x = 600; score = 0; scoreEl.innerText = 0; gameRunning = true; document.getElementById('gameTip').innerText = ">>> æ­£åœ¨æ¸¸æˆä¸­ <<<"; requestAnimationFrame(update); }
            function jump() { if(!gameRunning) reset(); else if(dino.y === dino.ground) dino.dy = dino.jumpPower; }
            canvas.addEventListener('mousedown', jump); canvas.addEventListener('touchstart', (e) => { e.preventDefault(); jump(); }); document.addEventListener('keydown', (e) => { if(e.code === 'Space') { e.preventDefault(); jump(); } });
            function update() {
                if(!gameRunning) return;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.beginPath(); ctx.moveTo(0, 125); ctx.lineTo(600, 125); ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.lineWidth = 2; ctx.stroke();
                if(dino.y < dino.ground) dino.dy += gravity; dino.y += dino.dy; if(dino.y > dino.ground) { dino.y = dino.ground; dino.dy = 0; }
                ctx.font = "30px serif"; ctx.textAlign = "left"; ctx.textBaseline = "bottom";
                ctx.fillText("ğŸ¦–", dino.x, dino.y + 15); 
                cactus.x -= cactus.speed; if(cactus.x < -30) { cactus.x = 600 + Math.random() * 200; score++; scoreEl.innerText = score; cactus.speed += 0.1; }
                ctx.fillText("ğŸŒµ", cactus.x, 125);
                if(dino.x < cactus.x + 20 && dino.x + 20 > cactus.x && dino.y > dino.ground - 20) {
                    gameRunning = false; ctx.fillStyle = 'white'; ctx.font = 'bold 24px monospace'; ctx.textAlign = 'center'; ctx.fillText("GAME OVER", 300, 60); ctx.font = '16px monospace'; ctx.fillText("TAP TO RESTART", 300, 90); document.getElementById('gameTip').innerText = "ç‚¹å‡»å±å¹•é‡è¯• / TAP TO RESTART";
                } else requestAnimationFrame(update);
            }
            ctx.fillStyle = 'rgba(255,255,255,0.8)'; ctx.font = 'bold 20px monospace'; ctx.textAlign = 'center'; ctx.fillText("TAP TO START", 300, 70);
        }
        window.onload = init;
    </script>
</body>
</html>