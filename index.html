<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KANG Mining & Dino</title>
    
    <script src="https://cdn.staticfile.org/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=VT323&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            /* èƒŒæ™¯å›¾ */
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                              radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                              radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            background-size: cover;
            color: #fff;
            min-height: 100vh;
            /* ğŸŸ¢ å¸ƒå±€ä¿®å¤ï¼šå‚ç›´æ’åˆ—ï¼Œé˜²æ­¢é‡å  */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 2rem 1rem;
            gap: 1.5rem;
        }
        
        /* 1. æ ‡é¢˜å®¹å™¨ (ä¿®å¤é‡å½±é—®é¢˜) */
        .header-box {
            position: relative;
            z-index: 20;
            text-align: center;
            margin-bottom: 0.5rem;
            /* å¢åŠ æ–‡å­—é˜´å½±ï¼Œé˜²æ­¢èƒŒæ™¯å¹²æ‰° */
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* 2. æŒ–çŸ¿å¡ç‰‡ */
        .glass-card {
            background: rgba(30, 41, 59, 0.7); /* åŠ æ·±èƒŒæ™¯ï¼Œæå‡å¯¹æ¯”åº¦ */
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            width: 100%; max-width: 400px; border-radius: 24px; padding: 2rem;
            position: relative; z-index: 10;
        }

        /* 3. æ¸¸æˆå¡ç‰‡ (é«˜äº®ä¼˜åŒ–) */
        .game-card {
            background: rgba(255, 255, 255, 0.05); /* ç¨å¾®æäº® */
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            width: 100%; max-width: 400px;
            padding: 1rem;
            text-align: center;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn-gold {
            background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%);
            color: #3e2723; transition: all 0.2s; font-weight: 800; border: none;
            cursor: pointer; opacity: 1 !important;
        }
        .btn-gold:active { transform: scale(0.98); }
        
        .btn-green {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: #064e3b; transition: all 0.2s; font-weight: 800; border: none;
            cursor: pointer; opacity: 1 !important;
        }
        .btn-green:active { transform: scale(0.98); }

        .pot-glow { text-shadow: 0 0 25px rgba(255, 215, 0, 0.4); }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); }
        .mini-btn {
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: #94a3b8;
            padding: 10px; border-radius: 12px; font-size: 0.75rem; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
        }
        
        /* ğŸ® æ¸¸æˆç”»å¸ƒä¼˜åŒ– */
        canvas { 
            background: rgba(255, 255, 255, 0.1); /* ğŸŸ¢ å˜äº®ï¼šæ”¹ä¸ºåŠé€æ˜ç™½è‰²èƒŒæ™¯ */
            border-radius: 8px; 
            width: 100%; 
            image-rendering: pixelated;
            touch-action: none;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* æ–‡å­—é—ªçƒåŠ¨ç”» */
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.3; } }
    </style>
</head>
<body>

    <div class="header-box">
        <h1 class="text-3xl font-extrabold tracking-tight text-white">KANG <span class="text-yellow-500">PROTOCOL</span></h1>
        <p class="text-[10px] text-gray-400 mt-1 tracking-[0.2em] uppercase">Fair Launch â€¢ Win or Share</p>
    </div>

    <div class="glass-card fade-in">
        
        <div class="text-center mb-6">
            <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Current Reward Pot</div>
            <div class="relative">
                <div id="potValue" class="text-3xl md:text-5xl font-black text-white pot-glow font-mono break-all">LOADING</div>
                <div class="text-xs font-bold text-yellow-500 mt-2">PENDING KANG TOKENS</div>
            </div>
        </div>

        <div id="connectView" class="text-center">
            <button onclick="connectWallet()" class="btn-gold w-full py-4 rounded-xl text-lg shadow-lg flex items-center justify-center gap-2">
                <i class="fas fa-wallet"></i> è¿æ¥é’±åŒ… (Connect)
            </button>
            <p class="text-xs text-gray-500 mt-4">Connect wallet to start mining</p>
        </div>

        <div id="miningView" class="hidden space-y-4">
            <div id="statusLog" class="bg-gray-800/50 rounded-lg p-3 text-xs text-center text-gray-300 font-mono border border-gray-700/50">
                å‡†å¤‡å°±ç»ª System Ready
            </div>

            <div class="bg-yellow-900/30 border border-yellow-700/50 rounded-lg p-3 text-left">
                <div class="text-[10px] text-yellow-500 font-bold mb-1 flex items-center gap-1">
                    <i class="fas fa-exclamation-triangle"></i> RULES:
                </div>
                <ul class="text-[10px] text-gray-300 list-disc list-inside space-y-1">
                    <li>æƒ³åˆ†é’±å¿…é¡»å…ˆç‚¹ <span class="text-yellow-400 font-bold">ç«‹å³æŠ¢å¤º</span>ã€‚</li>
                    <li>ç‚¹å‡» <span class="text-green-400 font-bold">ç»“ç®—</span> è§¦å‘åˆ†çº¢ï¼Œè· 5% èµé‡‘ã€‚</li>
                </ul>
            </div>

            <div class="grid gap-3">
                <button id="submitBtn" onclick="submitClaim()" class="btn-gold w-full py-4 rounded-xl text-lg shadow-lg relative overflow-hidden">
                    <div class="relative z-10 flex items-center justify-center gap-2">
                        <i class="fas fa-hammer"></i> ç«‹å³æŠ¢å¤º (Submit)
                    </div>
                </button>

                <button id="finalizeBtn" onclick="finalizePayout()" class="btn-green w-full py-4 rounded-xl font-bold text-lg shadow-lg">
                    <div class="flex items-center justify-center gap-2">
                        <i class="fas fa-download"></i> ç»“ç®—é¢†å¸ (Finalize)
                    </div>
                </button>
            </div>

            <div class="text-center pt-2">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-black/20 text-[10px] text-gray-400 font-mono">
                    <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                    <span id="userDisplay">0x00...0000</span>
                </div>
            </div>
        </div>

        <div class="action-grid">
            <div class="mini-btn" onclick="copyCA()">
                <i class="fas fa-copy"></i>
                <span>å¤åˆ¶åˆçº¦</span>
            </div>
            <div class="mini-btn" onclick="openBscScan()">
                <i class="fas fa-external-link-alt"></i>
                <span>æŸ¥çœ‹ BscScan</span>
            </div>
        </div>
    </div>

    <div class="game-card fade-in" style="animation-delay: 0.2s;">
        <div class="flex justify-between items-center mb-2 px-1">
            <div class="text-[10px] text-gray-300 font-mono font-bold"><i class="fas fa-gamepad"></i> ç­‰å¾…æ— èŠï¼Ÿç©ä¼šæ¸¸æˆï¼</div>
            <div class="text-[10px] text-yellow-400 font-mono font-bold">SCORE: <span id="gameScore">0</span></div>
        </div>
        
        <canvas id="dinoCanvas" width="600" height="150"></canvas>
        
        <div class="text-[10px] text-yellow-200 mt-2 font-mono blink" id="gameTip">
            ğŸ‘‰ ç‚¹å‡»å±å¹• / æŒ‰ç©ºæ ¼é”® å¼€å§‹è·³è·ƒ ğŸ‘ˆ
        </div>
    </div>

    <script>
        // --- DAPP é€»è¾‘ ---
        const CA = "0x65a762e8B7639596dbFBCcd9A541d44B0CF67762";
        const ABI = [
            "function submitClaim() public",
            "function finalizePayout() public",
            "function checkCurrentPot() public view returns (uint256)",
            "function currentCycleId() public view returns (uint256)",
            "function lastClaimedCycleId(address) public view returns (uint256)",
            "function currentCycle() public view returns (uint256, uint256, address[], bool)"
        ];

        let provider, signer, contract, readOnlyContract;
        
        const el = {
            pot: document.getElementById('potValue'),
            connectView: document.getElementById('connectView'),
            miningView: document.getElementById('miningView'),
            status: document.getElementById('statusLog'),
            submit: document.getElementById('submitBtn'),
            finalize: document.getElementById('finalizeBtn'),
            user: document.getElementById('userDisplay')
        };

        // --- åˆå§‹åŒ– ---
        async function init() {
            if(typeof ethers === 'undefined') { el.pot.innerText = "Error"; return; }
            try {
                const rpc = new ethers.providers.JsonRpcProvider("https://bsc-dataseed.binance.org/");
                readOnlyContract = new ethers.Contract(CA, ABI, rpc);
                loopPot();
            } catch(e) {}
            if(window.ethereum) {
                const acc = await window.ethereum.request({method:'eth_accounts'});
                if(acc.length > 0) connectWallet();
            }
            initGame();
        }

        async function loopPot() {
            if(readOnlyContract) {
                try {
                    const v = await readOnlyContract.checkCurrentPot();
                    el.pot.innerText = parseFloat(ethers.utils.formatUnits(v, 18)).toFixed(4);
                } catch(e) {}
            }
            setTimeout(loopPot, 3000);
        }

        async function connectWallet() {
            if(!window.ethereum) return alert("è¯·åœ¨é’±åŒ…æµè§ˆå™¨ä¸­æ‰“å¼€ï¼");
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                await switchToBSC();
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(CA, ABI, signer);
                const addr = await signer.getAddress();
                el.connectView.classList.add('hidden');
                el.miningView.classList.remove('hidden');
                el.user.innerText = addr.slice(0,6) + "..." + addr.slice(-4);
            } catch(e) { alert("è¿æ¥å¤±è´¥: " + e.message); }
        }

        async function submitClaim() {
            try {
                setStatus("æ­£åœ¨è¯·æ±‚ç­¾å...", "loading");
                const tx = await contract.submitClaim();
                setStatus("ä¸Šé“¾ä¸­...ç©æŠŠæ¸¸æˆç­‰å¾…å§ï¼", "loading"); 
                await tx.wait();
                setStatus("âœ… ç™»è®°æˆåŠŸï¼ç­‰å¾…ç»“ç®—...", "success");
            } catch(e) { handleErr(e); }
        }

        async function finalizePayout() {
            try {
                setStatus("æ­£åœ¨ç»“ç®—...", "loading");
                const tx = await contract.finalizePayout();
                await tx.wait();
                setStatus("ğŸ‰ ç»“ç®—æˆåŠŸï¼èµé‡‘åˆ°è´¦", "success");
                setTimeout(() => { location.reload(); }, 2000);
            } catch(e) { handleErr(e); }
        }

        async function switchToBSC() {
            try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x38' }] }); } catch (e) {
                if (e.code === 4902) await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: '0x38', chainName: 'Binance Smart Chain', nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 }, rpcUrls: ['https://bsc-dataseed.binance.org/'], blockExplorerUrls: ['https://bscscan.com/'] }] });
            }
        }

        function setStatus(msg, type) {
            el.status.innerText = msg;
            el.status.className = "rounded-lg p-3 text-xs text-center font-mono border transition-all ";
            if(type === 'loading') el.status.className += "bg-blue-900/30 text-blue-300 border-blue-800 animate-pulse";
            else if(type === 'success') el.status.className += "bg-green-900/30 text-green-300 border-green-800";
            else if(type === 'warn') el.status.className += "bg-yellow-900/30 text-yellow-300 border-yellow-800";
            else el.status.className += "bg-gray-800/50 text-gray-300 border-gray-700/50";
        }

        function handleErr(e) {
            let m = "äº¤æ˜“å¤±è´¥";
            if(e.reason) m = e.reason;
            if(e.message && e.message.includes("user rejected")) m = "ç”¨æˆ·å–æ¶ˆ";
            if(m.includes("Already submitted")) m = "æœ¬è½®å·²ç™»è®°ï¼è¯·ç›´æ¥ç‚¹ç»“ç®—";
            setStatus("âŒ " + m, "error");
        }

        function copyCA() { navigator.clipboard.writeText(CA); alert("âœ… åœ°å€å·²å¤åˆ¶"); }
        function openBscScan() { window.open(`https://bscscan.com/address/${CA}`, '_blank'); }

        // --- ğŸ® æ¸¸æˆå¼•æ“ (é«˜äº®ä¼˜åŒ–ç‰ˆ) ---
        function initGame() {
            const canvas = document.getElementById('dinoCanvas');
            const ctx = canvas.getContext('2d');
            const scoreEl = document.getElementById('gameScore');
            
            let gameRunning = false;
            let score = 0;
            // ğŸ¦– æé¾™é¢œè‰²ï¼šäº®æ©™è‰²
            let dino = { x: 50, y: 100, w: 20, h: 20, dy: 0, jumpPower: -8, ground: 100, color: '#f97316' };
            // ğŸŒµ ä»™äººæŒé¢œè‰²ï¼šäº®ç»¿è‰²
            let cactus = { x: 600, y: 100, w: 10, h: 20, speed: 4, color: '#4ade80' };
            let gravity = 0.4;

            function reset() {
                dino.y = dino.ground; dino.dy = 0;
                cactus.x = 600; score = 0; scoreEl.innerText = 0;
                gameRunning = true;
                document.getElementById('gameTip').innerText = ">>> æ­£åœ¨æ¸¸æˆä¸­ <<<";
                requestAnimationFrame(update);
            }

            function jump() {
                if(!gameRunning) reset();
                else if(dino.y === dino.ground) dino.dy = dino.jumpPower;
            }

            canvas.addEventListener('mousedown', jump);
            canvas.addEventListener('touchstart', (e) => { e.preventDefault(); jump(); });
            document.addEventListener('keydown', (e) => { if(e.code === 'Space') { e.preventDefault(); jump(); } });

            function update() {
                if(!gameRunning) return;

                // æ¸…å±
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // åœ°é¢çº¿ (ç™½è‰²)
                ctx.beginPath(); ctx.moveTo(0, 120); ctx.lineTo(600, 120);
                ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.lineWidth = 2; ctx.stroke();

                // æé¾™
                if(dino.y < dino.ground) dino.dy += gravity;
                dino.y += dino.dy;
                if(dino.y > dino.ground) { dino.y = dino.ground; dino.dy = 0; }
                
                ctx.fillStyle = dino.color;
                ctx.fillRect(dino.x, dino.y, dino.w, dino.h);
                // ç»™æé¾™åŠ ä¸ªå‘å…‰æ•ˆæœ
                ctx.shadowBlur = 10; ctx.shadowColor = dino.color;

                // ä»™äººæŒ
                ctx.shadowBlur = 0; // ä»™äººæŒä¸å‘å…‰
                cactus.x -= cactus.speed;
                if(cactus.x < -20) {
                    cactus.x = 600 + Math.random() * 200;
                    score++; scoreEl.innerText = score;
                    cactus.speed += 0.1;
                }
                ctx.fillStyle = cactus.color;
                ctx.fillRect(cactus.x, cactus.y, cactus.w, cactus.h);

                // ç¢°æ’æ£€æµ‹
                if(dino.x < cactus.x + cactus.w && dino.x + dino.w > cactus.x && dino.y < cactus.y + cactus.h && dino.y + dino.h > cactus.y) {
                    gameRunning = false;
                    ctx.fillStyle = 'white'; ctx.font = 'bold 24px monospace'; ctx.textAlign = 'center';
                    ctx.fillText("GAME OVER", 300, 60);
                    ctx.font = '16px monospace';
                    ctx.fillText("TAP TO RESTART", 300, 90);
                    document.getElementById('gameTip').innerText = "ç‚¹å‡»å±å¹•é‡è¯• / TAP TO RESTART";
                } else {
                    requestAnimationFrame(update);
                }
            }

            // åˆå§‹ç”»é¢æ–‡å­—
            ctx.fillStyle = 'rgba(255,255,255,0.8)'; ctx.font = 'bold 20px monospace'; ctx.textAlign = 'center';
            ctx.fillText("READY?", 300, 70);
        }

        window.onload = init;
    </script>
</body>
</html>